<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
<title>WRITING BUILDER</title>
<link href="https://fonts.googleapis.com/css2?family=Barlow+Condensed:wght@700;800;900&family=Instrument+Sans:ital,wght@0,400;0,500;0,600;0,700;1,400&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet"/>
<style>
:root{
  --bg:#FAF9F7;--ink:#1C1C1E;--ink2:rgba(28,28,30,0.92);--ink3:rgba(28,28,30,0.68);
  --red:#c9140f;--red-s:rgba(201,20,15,0.08);--border:rgba(28,28,30,0.08);
  --c-intro:#3d9e95;--c-b1:#c9140f;--c-b3:#7b5ea7;--c-conc:#2d7a3a;
  --footer-h:148px;
}
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
html,body{width:100%;height:100%;overflow:hidden;position:fixed;background:var(--bg);
  font-family:'Instrument Sans',sans-serif;color:var(--ink);-webkit-font-smoothing:antialiased;}
.shell{position:fixed;inset:0;display:flex;flex-direction:column;}
.topbar{flex-shrink:0;display:flex;align-items:center;gap:10px;padding:10px 18px 9px;
  background:rgba(250,249,247,0.97);border-bottom:1px solid var(--border);backdrop-filter:blur(14px);z-index:100;position:relative;overflow:hidden;}
.logo{font-family:'Barlow Condensed',sans-serif;font-size:18px;font-weight:900;letter-spacing:4px;text-transform:uppercase;position:relative;z-index:2;}
.logo span{color:var(--red);}
.spacer{flex:1;}
.tbctr{font-family:'DM Mono',monospace;font-size:11px;letter-spacing:1.5px;color:var(--ink3);position:relative;z-index:2;}
.topbar-words{position:absolute;inset:0;display:flex;align-items:center;gap:18px;padding:0 160px 0 190px;overflow:hidden;pointer-events:none;z-index:1;}
.tw{font-family:'DM Mono',monospace;font-size:8px;font-weight:500;letter-spacing:2px;text-transform:uppercase;color:rgba(28,28,30,0.055);white-space:nowrap;flex-shrink:0;}
.tw.red{color:rgba(201,20,15,0.07);}
.tw.lg{font-family:'Barlow Condensed',sans-serif;font-size:11px;font-weight:900;letter-spacing:3px;color:rgba(28,28,30,0.06);}
.stage{flex:1;min-height:0;position:relative;overflow:hidden;display:flex;align-items:center;justify-content:center;background:var(--bg);padding-bottom:20px;}
.bg-layer{position:absolute;inset:0;pointer-events:none;overflow:hidden;z-index:0;}
.bw{position:absolute;font-family:'Barlow Condensed',sans-serif;font-weight:900;text-transform:uppercase;letter-spacing:2px;line-height:1;user-select:none;white-space:nowrap;}
.bw.mono{font-family:'DM Mono',monospace;font-weight:500;letter-spacing:3px;}
.bw.l1{top:4%;left:1%;font-size:clamp(9px,1.4vw,13px);color:rgba(201,20,15,0.13);transform:rotate(-90deg) translateX(-100%);transform-origin:top left;}
.bw.l2{top:16%;left:1%;font-size:clamp(8px,1.1vw,11px);color:rgba(28,28,30,0.09);transform:rotate(-90deg) translateX(-100%);transform-origin:top left;}
.bw.l3{top:30%;left:1%;font-size:clamp(8px,1.1vw,11px);color:rgba(61,158,149,0.12);transform:rotate(-90deg) translateX(-100%);transform-origin:top left;}
.bw.l4{top:44%;left:1%;font-size:clamp(9px,1.4vw,13px);color:rgba(28,28,30,0.08);transform:rotate(-90deg) translateX(-100%);transform-origin:top left;}
.bw.l5{top:58%;left:1%;font-size:clamp(8px,1.1vw,11px);color:rgba(201,20,15,0.1);transform:rotate(-90deg) translateX(-100%);transform-origin:top left;}
.bw.l6{top:72%;left:1%;font-size:clamp(8px,1.1vw,11px);color:rgba(28,28,30,0.07);transform:rotate(-90deg) translateX(-100%);transform-origin:top left;}
.bw.l7{top:84%;left:1%;font-size:clamp(9px,1.3vw,12px);color:rgba(123,94,167,0.1);transform:rotate(-90deg) translateX(-100%);transform-origin:top left;}
.bw.r1{top:6%;right:0;font-size:clamp(9px,1.4vw,13px);color:rgba(28,28,30,0.09);transform:rotate(90deg) translateX(100%);transform-origin:top right;}
.bw.r2{top:18%;right:0;font-size:clamp(8px,1.1vw,11px);color:rgba(201,20,15,0.12);transform:rotate(90deg) translateX(100%);transform-origin:top right;}
.bw.r3{top:32%;right:0;font-size:clamp(8px,1.1vw,11px);color:rgba(28,28,30,0.07);transform:rotate(90deg) translateX(100%);transform-origin:top right;}
.bw.r4{top:46%;right:0;font-size:clamp(9px,1.3vw,12px);color:rgba(61,158,149,0.11);transform:rotate(90deg) translateX(100%);transform-origin:top right;}
.bw.r5{top:60%;right:0;font-size:clamp(8px,1.1vw,11px);color:rgba(28,28,30,0.09);transform:rotate(90deg) translateX(100%);transform-origin:top right;}
.bw.r6{top:74%;right:0;font-size:clamp(8px,1.1vw,11px);color:rgba(201,20,15,0.1);transform:rotate(90deg) translateX(100%);transform-origin:top right;}
.bw.r7{top:86%;right:0;font-size:clamp(9px,1.4vw,13px);color:rgba(123,94,167,0.11);transform:rotate(90deg) translateX(100%);transform-origin:top right;}
.bw.t2{top:6%;left:50%;transform:translateX(-50%);font-size:clamp(34px,5.5vw,52px);color:rgba(28,28,30,0.025);letter-spacing:2px;}
.bw.b2{bottom:8%;left:50%;transform:translateX(-50%);font-size:clamp(30px,4.5vw,46px);color:rgba(201,20,15,0.025);letter-spacing:2px;}
.wm{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%) rotate(-22deg);font-family:'Barlow Condensed',sans-serif;font-size:clamp(70px,14vw,130px);font-weight:900;letter-spacing:6px;text-transform:uppercase;color:rgba(28,28,30,0.018);white-space:nowrap;pointer-events:none;user-select:none;z-index:0;}
.marquee-strip{position:absolute;left:0;right:0;overflow:hidden;white-space:nowrap;pointer-events:none;}
.marquee-strip.top-s{top:0;height:22px;border-bottom:1px solid rgba(28,28,30,0.04);}
.marquee-strip.bot-s{bottom:0;height:22px;border-top:1px solid rgba(28,28,30,0.04);}
.marquee-inner{display:inline-block;animation:mq 28s linear infinite;}
.marquee-inner.rev{animation-direction:reverse;animation-duration:34s;}
.mword{display:inline-block;font-family:'DM Mono',monospace;font-size:9px;font-weight:500;letter-spacing:2.5px;text-transform:uppercase;color:rgba(28,28,30,0.07);padding:0 14px;line-height:22px;}
.mword.accent{color:rgba(201,20,15,0.09);}
.mword.teal{color:rgba(61,158,149,0.09);}
.mword.purple{color:rgba(123,94,167,0.09);}
@keyframes mq{from{transform:translateX(0)}to{transform:translateX(-50%)}}
.stat-block{position:absolute;pointer-events:none;}
.stat-block.sb1{top:50%;left:1.5%;transform:translateY(-50%);}
.stat-block.sb2{top:50%;right:1.5%;transform:translateY(-50%);}
.sb-inner{display:flex;flex-direction:column;gap:8px;}
.sb-item{font-family:'DM Mono',monospace;font-size:8px;letter-spacing:1.5px;text-transform:uppercase;color:rgba(28,28,30,0.07);line-height:1.4;writing-mode:vertical-rl;}
.sb-num{font-family:'Barlow Condensed',sans-serif;font-size:clamp(14px,2.5vw,22px);font-weight:900;color:rgba(28,28,30,0.055);letter-spacing:1px;writing-mode:vertical-rl;}
.sb-num.red{color:rgba(201,20,15,0.08);}
.sb-num.teal{color:rgba(61,158,149,0.08);}
.poster{position:relative;width:min(460px,93vw);height:min(530px,calc(var(--stage-h,100vh) - 48px));background:#fff;border-radius:22px;border:1px solid rgba(28,28,30,0.10);display:flex;flex-direction:column;overflow:hidden;flex-shrink:0;box-shadow:4px 6px 0 rgba(0,0,0,.07),0 24px 55px rgba(0,0,0,.13),0 4px 14px rgba(0,0,0,.07);animation:pIn .42s cubic-bezier(.22,1,.36,1) both;z-index:1;}
.poster::before{content:'';position:absolute;bottom:-8px;left:6px;right:6px;height:100%;background:#fff;border:1px solid rgba(0,0,0,.07);border-radius:22px;z-index:-1;}
.poster::after{content:'';position:absolute;bottom:-15px;left:13px;right:13px;height:100%;background:#fff;border:1px solid rgba(0,0,0,.05);border-radius:22px;z-index:-2;}
@keyframes pIn{from{opacity:0;transform:translateY(18px) scale(.96);}to{opacity:1;transform:none;}}
.flag{position:absolute;top:-2px;left:22px;z-index:10;}
.flag-body{min-width:80px;padding:11px 14px 10px;display:flex;align-items:center;justify-content:center;position:relative;}
.flag-num{font-family:'Barlow Condensed',sans-serif;font-size:15px;font-weight:900;letter-spacing:2px;text-transform:uppercase;color:#fff;white-space:nowrap;}
.flag-body::after{content:'';position:absolute;bottom:-8px;left:0;right:0;height:9px;background:inherit;clip-path:polygon(0% 0%,8.33% 100%,16.66% 0%,25% 100%,33.33% 0%,41.66% 100%,50% 0%,58.33% 100%,66.66% 0%,75% 100%,83.33% 0%,91.66% 100%,100% 0%);}
.section-lbl{position:absolute;top:16px;right:20px;font-family:'Barlow Condensed',sans-serif;font-size:11px;font-weight:900;letter-spacing:3px;text-transform:uppercase;opacity:.3;}
.card-dots-row{flex-shrink:0;display:flex;align-items:center;justify-content:space-between;padding:7px 16px 6px;border-top:1px solid rgba(0,0,0,.06);}
.card-arrow{width:30px;height:30px;border-radius:50%;background:transparent;border:none;font-size:18px;font-weight:700;color:var(--ink3);cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .18s;}
.card-arrow:hover:not([disabled]){color:var(--ink);background:rgba(0,0,0,.07);}
.card-arrow[disabled]{opacity:.15;cursor:not-allowed;}
.dots{display:flex;gap:5px;align-items:center;}
.dot{width:6px;height:6px;border-radius:50%;background:rgba(0,0,0,.16);transition:all .3s cubic-bezier(.22,1,.36,1);}
.dot.active{width:18px;border-radius:3px;background:var(--ink);}
.dot.done{background:rgba(0,0,0,.34);}
.accent-bar{height:5px;flex-shrink:0;}
.footer{flex-shrink:0;background:rgba(250,249,247,0.99);border-top:1px solid var(--border);backdrop-filter:blur(16px);z-index:999;padding-bottom:calc(env(safe-area-inset-bottom,0px) + 6px);position:relative;}
.play-cluster{position:fixed;left:50%;transform:translateX(-50%);bottom:calc(var(--footer-h, 60px) + 10px);z-index:1000;display:flex;align-items:center;gap:10px;background:rgba(250,249,247,0.92);backdrop-filter:blur(16px);border:1px solid rgba(28,28,30,0.10);border-radius:50px;padding:5px 10px 5px 10px;box-shadow:0 4px 18px rgba(0,0,0,.14),0 1px 4px rgba(0,0,0,.08);}
.btn-play-inline{width:32px;height:32px;border-radius:50%;border:none;background:var(--ink);color:#fff;cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0;font-size:12px;box-shadow:0 2px 0 rgba(0,0,0,.28),0 4px 10px rgba(0,0,0,.18);transition:all .18s;}
.btn-play-inline:active{transform:translateY(1px);box-shadow:0 1px 0 rgba(0,0,0,.28);}
.btn-play-inline.running{background:var(--red);box-shadow:0 3px 0 rgba(100,6,6,.4),0 5px 14px rgba(201,20,15,.24);}
.btn-nav{width:34px;height:34px;border-radius:50%;background:transparent;border:none;font-size:18px;font-weight:700;color:var(--ink3);cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .18s;}
.btn-nav:hover:not([disabled]){color:var(--ink);background:rgba(0,0,0,.07);}
.btn-nav:active:not([disabled]){transform:scale(.92);}
.btn-nav[disabled]{opacity:.15;cursor:not-allowed;}
.wave-mini{display:flex;align-items:flex-end;gap:2px;height:16px;width:22px;}
.wave-mini .wb{width:3px;border-radius:1.5px;background:var(--ink3);}
.wave-mini.on .wb{animation:wv .9s ease-in-out infinite;}
.wave-mini.off .wb{animation:none;transform:scaleY(.22);opacity:.18;}
@keyframes wv{0%,100%{height:3px;opacity:.3;}25%{height:14px;opacity:.9;}50%{height:7px;opacity:.6;}75%{height:11px;opacity:.8;}}
.wave-mini.on .wb:nth-child(1){animation-delay:0s;}.wave-mini.on .wb:nth-child(2){animation-delay:.13s;}.wave-mini.on .wb:nth-child(3){animation-delay:.26s;}.wave-mini.on .wb:nth-child(4){animation-delay:.39s;}.wave-mini.on .wb:nth-child(5){animation-delay:.52s;}
.tab-bar-wrap{display:flex;align-items:center;justify-content:center;padding:10px 18px 10px;}
.tab-bar{display:inline-flex;align-items:center;background:rgba(0,0,0,.08);border-radius:30px;padding:4px;gap:2px;}
.tab-btn{font-family:'DM Mono',monospace;font-size:11px;letter-spacing:1.2px;text-transform:uppercase;padding:8px 16px;border-radius:24px;border:none;cursor:pointer;background:transparent;color:var(--ink3);transition:all .22s cubic-bezier(.22,1,.36,1);white-space:nowrap;font-weight:500;}
.tab-btn.active{background:var(--ink);color:#fff;box-shadow:0 2px 8px rgba(0,0,0,.22);}
@media(max-width:400px){.tab-btn{font-size:9px;padding:7px 10px;}}
.scene{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:10px;pointer-events:none;opacity:0;}
.scene.active{opacity:1;pointer-events:all;}
.sentence-scroll{flex:1;min-height:0;overflow-y:auto;display:flex;flex-direction:column;gap:6px;scrollbar-width:none;}
.sentence-scroll::-webkit-scrollbar{display:none;}
.s-line{font-family:'Instrument Sans',sans-serif;font-size:15px;font-weight:400;line-height:1.6;color:rgba(17,17,17,.80);flex-shrink:0;opacity:0;transform:translateY(7px);transition:opacity .36s ease,transform .42s cubic-bezier(.22,1,.36,1);padding:5px 0;border-bottom:1px solid rgba(0,0,0,.05);}
.s-line:last-child{border-bottom:none;}
.s-line.in{opacity:1;transform:none;}
.s-line.first{color:var(--ink);font-weight:600;font-size:16px;}
.s-role{display:inline-block;font-family:'DM Mono',monospace;font-size:9px;font-weight:500;letter-spacing:1.5px;text-transform:uppercase;padding:2px 7px;border-radius:2px;margin-right:8px;vertical-align:middle;border-left:2.5px solid currentColor;}
.pb-ov{position:fixed;inset:0 0 var(--footer-h) 0;z-index:200;background:#fff;display:flex;flex-direction:column;pointer-events:none;opacity:0;transition:opacity .24s;overflow:hidden;}
.pb-ov::before{content:'';position:absolute;inset:0;background:repeating-linear-gradient(0deg,transparent,transparent 47px,rgba(28,28,30,0.03) 47px,rgba(28,28,30,0.03) 48px);pointer-events:none;z-index:0;}
.pb-ov.show{opacity:1;pointer-events:all;}
.pb-header{flex-shrink:0;display:flex;align-items:stretch;border-bottom:3px solid var(--ink);position:relative;z-index:2;background:#fff;}
.pb-hflag{background:var(--red);padding:13px 22px;display:flex;align-items:center;gap:10px;border-right:2px solid var(--ink);}
.pb-hflag span{font-family:'Barlow Condensed',sans-serif;font-size:14px;font-weight:900;letter-spacing:3px;text-transform:uppercase;color:#fff;}
.pb-htitle{flex:1;padding:13px 24px;font-family:'Barlow Condensed',sans-serif;font-size:18px;font-weight:900;letter-spacing:3px;text-transform:uppercase;color:var(--ink);display:flex;align-items:center;}
.pb-hsub{padding:13px 22px;display:flex;align-items:center;font-family:'DM Mono',monospace;font-size:11px;letter-spacing:1.5px;color:var(--ink3);border-left:2px solid var(--ink);}
.pb-hstop{padding:10px 18px;display:flex;align-items:center;border-left:2px solid var(--ink);}
.pb-stop-btn{font-family:'Barlow Condensed',sans-serif;font-size:14px;font-weight:900;letter-spacing:2px;text-transform:uppercase;padding:8px 18px;border-radius:4px;border:2px solid var(--ink);background:transparent;color:var(--ink);cursor:pointer;transition:all .15s;}
.pb-stop-btn:hover{background:var(--ink);color:#fff;}
.pb-body{flex:1;min-height:0;display:grid;grid-template-columns:1fr 1fr;position:relative;z-index:1;overflow:hidden;}
.pb-col{display:flex;flex-direction:column;overflow:hidden;}
.pb-col.left{border-right:3px solid var(--ink);}
.pb-col-head{flex-shrink:0;display:flex;align-items:center;gap:16px;padding:14px 24px 12px;border-bottom:2px solid rgba(28,28,30,0.1);}
.pb-col-word{font-family:'Barlow Condensed',sans-serif;font-size:clamp(42px,7vw,64px);font-weight:900;letter-spacing:1px;line-height:.88;color:var(--ink);}
.pb-col-word.red{color:var(--red);}
.pb-col-desc{font-family:'DM Mono',monospace;font-size:10px;letter-spacing:2px;text-transform:uppercase;color:var(--ink3);line-height:1.5;}
.pb-cats{flex:1;min-height:0;display:flex;flex-direction:column;overflow:hidden;}
.pb-cat{flex:1;display:flex;align-items:stretch;border-bottom:1px solid rgba(28,28,30,0.07);}
.pb-cat:last-child{border-bottom:none;}
.pb-cat-bar{width:6px;flex-shrink:0;}
.pb-cat-body{flex:1;padding:8px 18px;display:flex;flex-direction:column;justify-content:center;gap:5px;}
.pb-cat-label{font-family:'Barlow Condensed',sans-serif;font-size:clamp(16px,2.4vw,22px);font-weight:900;letter-spacing:1px;text-transform:uppercase;line-height:1;}
.pb-cat-pills{display:flex;flex-wrap:wrap;gap:5px;}
.pb-pill{font-family:'DM Mono',monospace;font-size:clamp(10px,1.4vw,13px);letter-spacing:.3px;padding:4px 10px;border-radius:3px;background:rgba(28,28,30,0.05);color:var(--ink2);white-space:nowrap;border:1px solid rgba(28,28,30,0.08);}
.pb-pill.hi{font-weight:600;}
.pb-foot{height:5px;background:var(--red);flex-shrink:0;position:relative;z-index:2;}
.listing-ov{position:fixed;inset:0 0 var(--footer-h) 0;z-index:210;background:#fff;display:flex;flex-direction:column;pointer-events:none;opacity:0;transition:opacity .26s;overflow:hidden;}
.listing-ov::before{content:'';position:absolute;inset:0;background:repeating-linear-gradient(0deg,transparent,transparent 47px,rgba(28,28,30,0.03) 47px,rgba(28,28,30,0.03) 48px);pointer-events:none;z-index:0;}
.listing-ov.show{opacity:1;}
.listing-header{flex-shrink:0;display:flex;align-items:stretch;border-bottom:3px solid var(--ink);position:relative;z-index:2;background:#fff;}
.listing-hflag{background:var(--red);padding:13px 22px;display:flex;align-items:center;border-right:2px solid var(--ink);}
.listing-hflag span{font-family:'Barlow Condensed',sans-serif;font-size:14px;font-weight:900;letter-spacing:3px;text-transform:uppercase;color:#fff;}
.listing-htitle{flex:1;padding:13px 24px;font-family:'Barlow Condensed',sans-serif;font-size:18px;font-weight:900;letter-spacing:3px;text-transform:uppercase;color:var(--ink);display:flex;align-items:center;}
.listing-hsub{padding:13px 20px;display:flex;align-items:center;font-family:'DM Mono',monospace;font-size:11px;letter-spacing:1.5px;color:var(--ink3);border-left:2px solid var(--ink);}
.listing-kicker-row{flex-shrink:0;padding:14px 32px 10px;border-bottom:1px solid rgba(28,28,30,0.08);position:relative;z-index:1;}
.listing-kicker-big{font-family:'Barlow Condensed',sans-serif;font-size:clamp(20px,3.2vw,28px);font-weight:900;letter-spacing:1px;color:var(--ink);}
.listing-kicker-big em{font-style:normal;color:var(--red);}
.listing-sub-text{font-family:'DM Mono',monospace;font-size:11px;letter-spacing:1.5px;color:var(--ink3);margin-top:3px;}
.listing-rows{display:flex;flex-direction:column;flex:1;min-height:0;overflow:hidden;position:relative;z-index:1;}
.listing-row{display:flex;align-items:stretch;flex:1;border-bottom:1px solid rgba(28,28,30,0.07);}
.listing-row:last-child{border-bottom:none;}
.listing-row-marker{flex-shrink:0;width:clamp(150px,24vw,210px);display:flex;align-items:center;padding:10px 20px;border-right:2px solid rgba(28,28,30,0.08);font-family:'Barlow Condensed',sans-serif;font-weight:900;font-size:clamp(20px,3.5vw,34px);line-height:1;}
.listing-row-mid{flex-shrink:0;width:clamp(80px,11vw,105px);display:flex;align-items:center;justify-content:center;padding:8px 10px;border-right:1px solid rgba(28,28,30,0.06);}
.listing-row-mid-label{font-family:'DM Mono',monospace;font-size:9px;letter-spacing:2px;text-transform:uppercase;font-weight:600;text-align:center;line-height:1.3;}
.listing-row-example{flex:1;display:flex;align-items:center;padding:10px 22px;font-family:'Instrument Sans',sans-serif;font-size:clamp(16px,2.3vw,22px);line-height:1.45;color:var(--ink2);}
.listing-row-example em{font-style:italic;}
.listing-foot{height:5px;background:var(--red);flex-shrink:0;position:relative;z-index:1;}
.poster-ov{position:fixed;inset:0 0 var(--footer-h) 0;z-index:200;background:#fff;display:flex;align-items:stretch;pointer-events:none;opacity:0;transition:opacity .26s;overflow:hidden;}
.poster-ov::before{content:'';position:absolute;inset:0;background:repeating-linear-gradient(0deg,transparent,transparent 39px,rgba(28,28,30,0.03) 39px,rgba(28,28,30,0.03) 40px);pointer-events:none;z-index:0;}
.poster-ov.show{opacity:1;pointer-events:all;}
.pov-pillar{width:44px;flex-shrink:0;display:flex;align-items:center;justify-content:center;position:relative;z-index:2;}
.pov-pillar.left{border-right:1px solid rgba(28,28,30,0.08);}
.pov-pillar.right{border-left:1px solid rgba(28,28,30,0.08);}
.pov-pillar-text{font-family:'Barlow Condensed',sans-serif;font-size:10px;font-weight:900;letter-spacing:4px;text-transform:uppercase;color:rgba(28,28,30,0.15);writing-mode:vertical-rl;white-space:nowrap;}
.pov-card{flex:1;position:relative;background:#fff;overflow:hidden;display:flex;flex-direction:column;opacity:0;transform:translateX(20px);transition:opacity .3s .04s,transform .38s .04s cubic-bezier(.22,1,.36,1);z-index:1;}
.poster-ov.show .pov-card{opacity:1;transform:none;}
.pov-card.exit{opacity:0!important;transform:translateX(-44px)!important;transition:opacity .13s,transform .17s ease!important;}
.pov-flag{position:absolute;top:-2px;left:22px;z-index:10;}
.pov-flag-body{padding:10px 14px 9px;display:flex;align-items:center;justify-content:center;position:relative;}
.pov-flag-body::after{content:'';position:absolute;bottom:-8px;left:0;right:0;height:9px;background:inherit;clip-path:polygon(0% 0%,8.33% 100%,16.66% 0%,25% 100%,33.33% 0%,41.66% 100%,50% 0%,58.33% 100%,66.66% 0%,75% 100%,83.33% 0%,91.66% 100%,100% 0%);}
.pov-flag-num{font-family:'Barlow Condensed',sans-serif;font-size:14px;font-weight:900;color:#fff;white-space:nowrap;letter-spacing:2px;text-transform:uppercase;}
.pov-pair-lbl{position:absolute;top:16px;right:20px;font-family:'DM Mono',monospace;font-size:10px;letter-spacing:2px;text-transform:uppercase;color:var(--ink3);}
.pov-bottom-bar{height:5px;flex-shrink:0;}
.pov-card-foot{display:flex;align-items:center;justify-content:center;padding:10px 24px 14px;flex-shrink:0;border-top:1px solid rgba(0,0,0,.06);}
.pov-stop-btn{font-family:'Barlow Condensed',sans-serif;font-size:18px;font-weight:900;letter-spacing:3px;text-transform:uppercase;padding:12px 36px;border-radius:50px;border:none;background:var(--ink);color:#fff;cursor:pointer;transition:all .18s;box-shadow:0 4px 0 rgba(0,0,0,.25),0 6px 18px rgba(0,0,0,.18);}
.pov-stop-btn:hover{background:var(--red);}
.pov-dots{display:flex;gap:7px;margin-top:12px;}
.bdot{width:7px;height:7px;border-radius:50%;background:rgba(0,0,0,.14);transition:all .3s cubic-bezier(.22,1,.36,1);}
.bdot.active{transform:scale(1.8);background:var(--ink);}
.bdot.done{background:rgba(0,0,0,.3);}
.pov-intro-body{flex:1;min-height:0;padding:56px 48px 16px;display:flex;flex-direction:column;justify-content:center;overflow:hidden;}
.ob-hlbl{font-family:'DM Mono',monospace;font-size:10px;letter-spacing:2.5px;text-transform:uppercase;color:var(--c-intro);margin-bottom:8px;flex-shrink:0;}
.ob-starter{font-family:'Barlow Condensed',sans-serif;font-size:clamp(42px,8vw,80px);font-weight:900;line-height:.88;letter-spacing:1px;color:var(--ink);flex-shrink:0;}
.ob-rest{font-family:'Instrument Sans',sans-serif;font-weight:400;font-size:clamp(16px,2.2vw,22px);line-height:1.52;color:var(--ink2);margin-top:12px;flex-shrink:0;}
.ob-link{font-family:'Instrument Sans',sans-serif;font-weight:400;font-size:clamp(16px,2.2vw,22px);line-height:1.52;color:var(--ink2);margin-top:10px;flex-shrink:0;opacity:0;transform:translateY(4px);transition:opacity .34s .28s,transform .4s .28s cubic-bezier(.22,1,.36,1);}
.poster-ov.show .pov-card:not(.exit) .ob-link{opacity:1;transform:none;}
.ob-sep{margin:12px 0;display:flex;align-items:center;gap:10px;flex-shrink:0;}
.ob-sep::before{content:'';flex:1;height:1px;background:rgba(0,0,0,.08);}
.ob-sep::after{content:'↓';font-family:'Barlow Condensed',sans-serif;font-size:16px;font-weight:900;color:var(--c-intro);flex-shrink:0;line-height:1;}
.ob-tlbl{font-family:'DM Mono',monospace;font-size:10px;letter-spacing:2.5px;text-transform:uppercase;color:var(--c-intro);margin-bottom:6px;flex-shrink:0;opacity:0;transform:translateY(4px);transition:opacity .28s .44s,transform .32s .44s;}
.poster-ov.show .pov-card:not(.exit) .ob-tlbl{opacity:1;transform:none;}
.ob-tt{font-family:'Instrument Sans',sans-serif;font-weight:500;font-size:clamp(16px,2.2vw,22px);line-height:1.52;color:var(--ink2);opacity:0;transform:translateY(8px);transition:opacity .36s .52s,transform .42s .52s cubic-bezier(.22,1,.36,1);}
.ob-tt strong{color:var(--c-intro);font-weight:700;}
.poster-ov.show .pov-card:not(.exit) .ob-tt{opacity:1;transform:none;}
.pov-body-body{flex:1;min-height:0;padding:64px 60px 16px;display:flex;flex-direction:column;overflow-y:auto;scrollbar-width:none;}
.pov-body-body::-webkit-scrollbar{display:none;}
.inter-ov{position:fixed;inset:0 0 var(--footer-h) 0;z-index:200;background:rgba(250,249,247,0.97);display:flex;align-items:center;justify-content:center;pointer-events:none;opacity:0;transition:opacity .3s;overflow:hidden;}
.inter-ov::before{content:'';position:absolute;inset:0;background:repeating-linear-gradient(0deg,transparent,transparent 39px,rgba(28,28,30,0.03) 39px,rgba(28,28,30,0.03) 40px);pointer-events:none;}
.inter-ov.show{opacity:1;}
.inter-card{width:min(460px,93vw);height:min(530px,calc(var(--stage-h,100vh) - 48px));background:#fff;border-radius:22px;border:1px solid rgba(28,28,30,0.10);display:flex;flex-direction:column;overflow:hidden;flex-shrink:0;position:relative;box-shadow:4px 6px 0 rgba(0,0,0,.07),0 24px 55px rgba(0,0,0,.13),0 4px 14px rgba(0,0,0,.07);opacity:0;transform:translateY(20px) scale(.96);transition:opacity .38s .06s,transform .44s .06s cubic-bezier(.22,1,.36,1);}
.inter-card::before{content:'';position:absolute;bottom:-8px;left:6px;right:6px;height:100%;background:#fff;border:1px solid rgba(0,0,0,.07);border-radius:22px;z-index:-1;}
.inter-card::after{content:'';position:absolute;bottom:-15px;left:13px;right:13px;height:100%;background:#fff;border:1px solid rgba(0,0,0,.05);border-radius:22px;z-index:-2;}
.inter-ov.show .inter-card{opacity:1;transform:none;}
.inter-flag{position:absolute;top:-2px;left:22px;z-index:10;}
.inter-flag-body{min-width:80px;padding:11px 14px 10px;display:flex;align-items:center;justify-content:center;position:relative;}
.inter-flag-body::after{content:'';position:absolute;bottom:-8px;left:0;right:0;height:9px;background:inherit;clip-path:polygon(0% 0%,8.33% 100%,16.66% 0%,25% 100%,33.33% 0%,41.66% 100%,50% 0%,58.33% 100%,66.66% 0%,75% 100%,83.33% 0%,91.66% 100%,100% 0%);}
.inter-flag-num{font-family:'Barlow Condensed',sans-serif;font-size:15px;font-weight:900;color:#fff;letter-spacing:2px;text-transform:uppercase;white-space:nowrap;}
.inter-section-lbl{position:absolute;top:16px;right:20px;font-family:'Barlow Condensed',sans-serif;font-size:11px;font-weight:900;letter-spacing:3px;text-transform:uppercase;opacity:.3;}
.inter-body{flex:1;min-height:0;padding:52px 28px 16px;display:flex;flex-direction:column;justify-content:center;gap:10px;}
.inter-kicker{font-family:'DM Mono',monospace;font-size:10px;letter-spacing:3px;text-transform:uppercase;color:var(--ink3);}
.inter-big{font-family:'Barlow Condensed',sans-serif;font-size:clamp(42px,8vw,66px);font-weight:900;line-height:.88;letter-spacing:1px;color:var(--ink);}
.inter-big em{font-style:normal;color:var(--inter-accent,var(--red));}
.inter-sub{font-family:'Instrument Sans',sans-serif;font-size:clamp(14px,2vw,16px);line-height:1.55;color:var(--ink2);margin-top:4px;}
.inter-sub strong{color:var(--ink);font-weight:600;}
.inter-bottom{height:5px;flex-shrink:0;}
.sm-backdrop{position:fixed;inset:0;z-index:600;background:rgba(0,0,0,0);pointer-events:none;transition:background .28s;}
.sm-backdrop.open{background:rgba(0,0,0,.55);pointer-events:all;}
.sm-backdrop.dim{background:rgba(0,0,0,.35);pointer-events:none;}
.sm-wrap{position:fixed;left:50%;bottom:calc(var(--footer-h) + 18px);transform:translateX(-50%) translateY(30px);width:min(460px,93vw);max-height:calc(var(--stage-h, 80vh) - 36px);z-index:610;pointer-events:none;opacity:0;transition:opacity .26s,transform .36s cubic-bezier(.22,1,.36,1);}
.sm-wrap.open{opacity:1;transform:translateX(-50%) translateY(0);pointer-events:all;}
.sm-card{background:#1C1C1E;border-radius:22px;overflow:hidden;display:flex;flex-direction:column;position:relative;max-height:inherit;box-shadow:4px 6px 0 rgba(0,0,0,.5),0 0 0 1px rgba(255,255,255,.06),0 24px 55px rgba(0,0,0,.55),0 0 60px var(--sm-glow,rgba(201,20,15,.18));}
.sm-card::before{content:'';position:absolute;bottom:-8px;left:6px;right:6px;height:100%;background:#111;border-radius:22px;z-index:-1;border:1px solid rgba(255,255,255,.04);}
.sm-card::after{content:'';position:absolute;bottom:-15px;left:13px;right:13px;height:100%;background:#0a0a0a;border-radius:22px;z-index:-2;border:1px solid rgba(255,255,255,.03);}
.sm-flag{position:absolute;top:-2px;left:22px;z-index:10;}
.sm-flag-body{padding:10px 16px 9px;display:flex;align-items:center;justify-content:center;position:relative;}
.sm-flag-body::after{content:'';position:absolute;bottom:-8px;left:0;right:0;height:9px;background:inherit;clip-path:polygon(0% 0%,8.33% 100%,16.66% 0%,25% 100%,33.33% 0%,41.66% 100%,50% 0%,58.33% 100%,66.66% 0%,75% 100%,83.33% 0%,91.66% 100%,100% 0%);}
.sm-flag-txt{font-family:'Barlow Condensed',sans-serif;font-size:13px;font-weight:900;letter-spacing:2.5px;text-transform:uppercase;color:#fff;white-space:nowrap;}
.sm-section-lbl{position:absolute;top:16px;right:20px;font-family:'DM Mono',monospace;font-size:10px;font-weight:500;letter-spacing:2px;text-transform:uppercase;color:rgba(255,255,255,.3);}
.sm-body{flex:1;min-height:0;padding:54px 26px 12px;display:flex;flex-direction:column;gap:0;overflow-y:auto;scrollbar-width:none;}
.sm-body::-webkit-scrollbar{display:none;}
.sm-title{font-family:'Barlow Condensed',sans-serif;font-size:clamp(38px,8vw,58px);font-weight:900;line-height:.86;letter-spacing:1px;color:#fff;flex-shrink:0;margin-bottom:16px;}
.sm-divider{height:1px;background:rgba(255,255,255,.08);flex-shrink:0;margin:0 0 12px;}
.sm-phrase{display:flex;align-items:baseline;gap:12px;padding:10px 0;border-bottom:1px solid rgba(255,255,255,.06);flex-shrink:0;opacity:0;transform:translateX(-8px);transition:opacity .3s,transform .35s cubic-bezier(.22,1,.36,1);}
.sm-phrase:last-child{border-bottom:none;}
.sm-phrase.in{opacity:1;transform:none;}
.sm-phrase-bullet{width:6px;height:6px;border-radius:50%;flex-shrink:0;margin-top:5px;}
.sm-phrase-text{font-family:'Instrument Sans',sans-serif;font-size:clamp(15px,2.2vw,19px);font-weight:500;line-height:1.4;color:rgba(255,255,255,.88);}
.sm-phrase-note{font-family:'DM Mono',monospace;font-size:10px;letter-spacing:.5px;color:rgba(255,255,255,.35);margin-top:2px;}
.sm-foot-row{padding:0 0 2px;flex-shrink:0;}
.sm-timer-bar-wrap{height:4px;background:rgba(255,255,255,.08);border-radius:0 0 22px 22px;overflow:hidden;}
.sm-timer-bar{height:100%;width:100%;border-radius:0 0 22px 22px;transition:width linear;}
.sm-accent-bar{height:5px;flex-shrink:0;}
.sc2-chip{display:inline-flex;align-items:center;gap:7px;font-family:'Instrument Sans',sans-serif;font-size:clamp(13px,1.8vw,15px);font-weight:500;padding:2px 0;background:transparent;border:none;opacity:0;transform:translateX(-6px);transition:opacity .15s;}
.sc2-chip.in{opacity:1;transform:none;animation:chipLand .5s cubic-bezier(.22,1,.36,1) both;}
.sc2-chip:hover{opacity:.7;}
.sc2-chip:active{transform:scale(.97);}
@keyframes chipLand{0%{transform:translateX(-8px) rotate(-6deg);opacity:0;}45%{transform:translateX(2px) rotate(3deg);opacity:1;}70%{transform:translateX(-1px) rotate(-1deg);}100%{transform:none;}}
.notes-panel{position:fixed;inset:0;z-index:500;background:#FAF9F7;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:14px;pointer-events:none;opacity:0;transition:opacity .26s;}
.notes-panel.show{opacity:1;pointer-events:all;}
.notes-card{width:min(460px,96vw);height:min(600px,88vh);background:#fff;border-radius:22px;border:1px solid rgba(0,0,0,.06);box-shadow:4px 6px 0 rgba(0,0,0,.06),0 24px 60px rgba(0,0,0,.14);overflow:hidden;display:flex;flex-direction:column;opacity:0;transform:translateY(24px) scale(.96);transition:opacity .32s,transform .4s cubic-bezier(.22,1,.36,1);}
.notes-panel.show .notes-card{opacity:1;transform:none;}
.notes-top{height:5px;background:var(--ink);flex-shrink:0;}
.notes-header{display:flex;align-items:center;justify-content:space-between;padding:12px 20px;border-bottom:1px solid var(--border);flex-shrink:0;}
.notes-title{font-family:'Barlow Condensed',sans-serif;font-size:22px;font-weight:900;letter-spacing:2px;}
.notes-close{font-family:'DM Mono',monospace;font-size:10px;letter-spacing:1.5px;text-transform:uppercase;padding:6px 14px;border-radius:20px;background:rgba(0,0,0,.06);color:var(--ink3);border:1px solid var(--border);cursor:pointer;}
.notes-tabs{display:flex;gap:4px;padding:10px 16px 8px;border-bottom:1px solid var(--border);flex-shrink:0;overflow-x:auto;scrollbar-width:none;}
.ntab{font-family:'DM Mono',monospace;font-size:10px;letter-spacing:1.2px;text-transform:uppercase;padding:6px 14px;border-radius:16px;border:none;background:rgba(0,0,0,.05);color:var(--ink3);cursor:pointer;white-space:nowrap;transition:all .18s;}
.ntab.on{background:var(--ink);color:#fff;}
.notes-body{flex:1;overflow-y:auto;padding:16px 20px;}
.n-section{margin-bottom:18px;}
.n-stitle{font-family:'DM Mono',monospace;font-size:10px;letter-spacing:2px;text-transform:uppercase;color:var(--red);margin-bottom:8px;}
.n-item{font-family:'Instrument Sans',sans-serif;font-size:14px;line-height:1.55;color:var(--ink2);padding:6px 0;border-bottom:1px dashed rgba(0,0,0,.07);}
.n-item:last-child{border-bottom:none;}
.n-item strong{color:var(--ink);font-weight:600;}
.flash{position:fixed;inset:0;z-index:900;pointer-events:none;opacity:0;transition:opacity .08s;background:var(--red);}
.flash.pop{opacity:.04;transition:opacity 0s;}
.fem{position:fixed;pointer-events:none;z-index:800;font-size:20px;animation:femUp 2s ease-out forwards;}
@keyframes femUp{0%{opacity:0;transform:translateY(0) scale(.5);}15%{opacity:1;transform:translateY(-10px) scale(1.1);}80%{opacity:.8;transform:translateY(-90px);}100%{opacity:0;transform:translateY(-130px);}}
.skill-screen{position:fixed;inset:0;z-index:1000;background:var(--bg);display:flex;flex-direction:column;align-items:center;justify-content:center;padding:24px 20px;gap:18px;transition:opacity .28s,transform .28s cubic-bezier(.22,1,.36,1);}
.skill-screen.out{opacity:0;transform:scale(.96);pointer-events:none;}
.skill-header{text-align:center;}
.skill-main-title{font-family:'Barlow Condensed',sans-serif;font-size:clamp(32px,7vw,48px);font-weight:900;letter-spacing:2px;line-height:.88;color:var(--ink);}
.skill-main-title span{color:var(--red);}
.skill-main-sub{font-family:'DM Mono',monospace;font-size:10px;letter-spacing:3px;text-transform:uppercase;color:var(--ink3);margin-top:8px;}
.skill-grid{display:grid;grid-template-columns:1fr 1fr;gap:11px;width:100%;max-width:380px;}
.skill-card{background:#fff;border-radius:18px;border:1px solid rgba(28,28,30,.09);padding:18px 16px 14px;cursor:pointer;transition:all .22s cubic-bezier(.22,1,.36,1);box-shadow:3px 4px 0 rgba(0,0,0,.055),0 10px 28px rgba(0,0,0,.08);display:flex;flex-direction:column;gap:6px;position:relative;overflow:hidden;}
.skill-card::before{content:'';position:absolute;bottom:-7px;left:5px;right:5px;height:100%;background:#fff;border:1px solid rgba(0,0,0,.06);border-radius:18px;z-index:-1;}
.skill-card::after{content:'';position:absolute;bottom:-13px;left:11px;right:11px;height:100%;background:#fff;border:1px solid rgba(0,0,0,.04);border-radius:18px;z-index:-2;}
.skill-card:hover{transform:translateY(-4px) scale(1.025);box-shadow:4px 7px 0 rgba(0,0,0,.08),0 18px 40px rgba(0,0,0,.13);}
.skill-card:active{transform:scale(.97);}
.skill-card-bar{height:3px;border-radius:2px;margin-bottom:2px;}
.skill-card-name{font-family:'Barlow Condensed',sans-serif;font-size:clamp(24px,5.5vw,32px);font-weight:900;letter-spacing:1px;line-height:.9;}
.skill-card-type{font-family:'DM Mono',monospace;font-size:8px;letter-spacing:2px;text-transform:uppercase;color:var(--ink3);}
.skill-card-desc{font-family:'Instrument Sans',sans-serif;font-size:11px;color:var(--ink3);line-height:1.4;margin-top:1px;}
.back-pill{position:fixed;top:14px;left:16px;z-index:1100;display:none;font-family:'DM Mono',monospace;font-size:9px;letter-spacing:2px;text-transform:uppercase;padding:6px 14px;border-radius:20px;border:1px solid rgba(28,28,30,.15);background:rgba(250,249,247,.94);backdrop-filter:blur(12px);color:var(--ink3);cursor:pointer;transition:all .2s;}
.back-pill:hover{color:var(--ink);border-color:rgba(28,28,30,.3);}
</style>
</head>
<body>

<!-- SKILL SELECTOR -->
<div class="skill-screen" id="skillScreen">
  <div class="skill-header">
    <div class="skill-main-title">B2 WRITING<br><span>BUILDER</span></div>
    <div class="skill-main-sub">Choose a writing task</div>
  </div>
  <div class="skill-grid">
    <div class="skill-card" onclick="launchSkill('essay')">
      <div class="skill-card-bar" style="background:#c9140f;"></div>
      <div class="skill-card-name" style="color:#c9140f;">ESSAY</div>
      <div class="skill-card-type">Opinion · Argument</div>
      <div class="skill-card-desc">Hook · Claim · Support · Conclusion</div>
    </div>
    <div class="skill-card" onclick="launchSkill('report')">
      <div class="skill-card-bar" style="background:#1a5c8a;"></div>
      <div class="skill-card-name" style="color:#1a5c8a;">REPORT</div>
      <div class="skill-card-type">Formal · Objective</div>
      <div class="skill-card-desc">Purpose · Findings · Recommendation</div>
    </div>
    <div class="skill-card" onclick="launchSkill('review')">
      <div class="skill-card-bar" style="background:#2d7a3a;"></div>
      <div class="skill-card-name" style="color:#2d7a3a;">REVIEW</div>
      <div class="skill-card-type">Descriptive · Personal</div>
      <div class="skill-card-desc">Reputation · Features · Verdict</div>
    </div>
    <div class="skill-card" onclick="launchSkill('email')">
      <div class="skill-card-bar" style="background:#7b5ea7;"></div>
      <div class="skill-card-name" style="color:#7b5ea7;">EMAIL</div>
      <div class="skill-card-type">Formal · Informal</div>
      <div class="skill-card-desc">Opening · Purpose · Sign-off</div>
    </div>
  </div>
</div>

<button class="back-pill" id="backPill" onclick="goBack()">← Skills</button>

<div class="shell" id="playerShell" style="visibility:hidden;">
  <div class="topbar">
    <div class="topbar-words">
      <span class="tw red lg">THESIS</span><span class="tw">·</span><span class="tw">CLAIM</span><span class="tw">·</span><span class="tw red">REASON</span><span class="tw">·</span><span class="tw">EXAMPLE</span><span class="tw">·</span><span class="tw lg">RESULT</span><span class="tw">·</span><span class="tw">HOOK</span><span class="tw">·</span><span class="tw red">OPINION</span><span class="tw">·</span><span class="tw">LINKING WORD</span><span class="tw">·</span><span class="tw lg">FORMAL</span><span class="tw">·</span><span class="tw">TOPIC SENTENCE</span><span class="tw">·</span><span class="tw red">PARAGRAPH</span><span class="tw">·</span><span class="tw">EVIDENCE</span><span class="tw">·</span><span class="tw lg">B2 LEVEL</span>
    </div>
    <div class="logo" id="logoEl">ESSAY<span>_</span>BUILDER</div>
    <div class="spacer"></div>
    <div class="tbctr" id="ctr">1 / 4</div>
  </div>

  <div class="stage" id="stage">
    <div class="bg-layer">
      <div class="wm">WRITE</div>
      <div class="marquee-strip top-s"><div class="marquee-inner"><span class="mword accent">HOOK</span><span class="mword">·</span><span class="mword">THESIS STATEMENT</span><span class="mword">·</span><span class="mword teal">TOPIC SENTENCE</span><span class="mword">·</span><span class="mword">CLAIM</span><span class="mword">·</span><span class="mword accent">REASON</span><span class="mword">·</span><span class="mword">EXAMPLE</span><span class="mword">·</span><span class="mword accent">RESULT</span><span class="mword">·</span><span class="mword purple">OWN IDEA</span><span class="mword">·</span><span class="mword teal">LINKING WORD</span><span class="mword">·</span><span class="mword">RESTATE OPINION</span><span class="mword">·</span><span class="mword accent">B2 WRITING</span><span class="mword">·</span><span class="mword">FORMAL REGISTER</span><span class="mword">·</span><span class="mword">140–190 WORDS</span><span class="mword">·</span><span class="mword purple">5 PARAGRAPHS</span><span class="mword">·</span><span class="mword accent">HOOK</span><span class="mword">·</span><span class="mword">THESIS STATEMENT</span><span class="mword">·</span><span class="mword teal">TOPIC SENTENCE</span><span class="mword">·</span><span class="mword">CLAIM</span><span class="mword">·</span><span class="mword accent">REASON</span><span class="mword">·</span><span class="mword">EXAMPLE</span><span class="mword">·</span><span class="mword accent">RESULT</span><span class="mword">·</span><span class="mword purple">OWN IDEA</span><span class="mword">·</span><span class="mword teal">LINKING WORD</span><span class="mword">·</span><span class="mword">RESTATE OPINION</span><span class="mword">·</span><span class="mword accent">B2 WRITING</span><span class="mword">·</span><span class="mword">FORMAL REGISTER</span><span class="mword">·</span><span class="mword">140–190 WORDS</span><span class="mword">·</span><span class="mword purple">5 PARAGRAPHS</span><span class="mword">·</span></div></div>
      <div class="marquee-strip bot-s"><div class="marquee-inner rev"><span class="mword">IN MY OPINION</span><span class="mword">·</span><span class="mword teal">FURTHERMORE</span><span class="mword">·</span><span class="mword accent">IN ADDITION</span><span class="mword">·</span><span class="mword">HOWEVER</span><span class="mword">·</span><span class="mword purple">ON THE OTHER HAND</span><span class="mword">·</span><span class="mword">THIS IS BECAUSE</span><span class="mword">·</span><span class="mword accent">FOR EXAMPLE</span><span class="mword">·</span><span class="mword">AS A RESULT</span><span class="mword">·</span><span class="mword teal">CONSEQUENTLY</span><span class="mword">·</span><span class="mword">IN CONCLUSION</span><span class="mword">·</span><span class="mword accent">TO SUM UP</span><span class="mword">·</span><span class="mword">FIRSTLY</span><span class="mword">·</span><span class="mword purple">THEREFORE</span><span class="mword">·</span><span class="mword">IN MY OPINION</span><span class="mword">·</span><span class="mword teal">FURTHERMORE</span><span class="mword">·</span><span class="mword accent">IN ADDITION</span><span class="mword">·</span><span class="mword">HOWEVER</span><span class="mword">·</span><span class="mword purple">ON THE OTHER HAND</span><span class="mword">·</span><span class="mword">THIS IS BECAUSE</span><span class="mword">·</span><span class="mword accent">FOR EXAMPLE</span><span class="mword">·</span><span class="mword">AS A RESULT</span><span class="mword">·</span><span class="mword teal">CONSEQUENTLY</span><span class="mword">·</span><span class="mword">IN CONCLUSION</span><span class="mword">·</span><span class="mword accent">TO SUM UP</span><span class="mword">·</span><span class="mword">FIRSTLY</span><span class="mword">·</span><span class="mword purple">THEREFORE</span><span class="mword">·</span></div></div>
      <div class="bw l1">INTRODUCTION</div><div class="bw l2 mono">P1 · HOOK</div><div class="bw l3">THESIS</div><div class="bw l4 mono">P2 · CLAIM</div><div class="bw l5">BODY PARAGRAPH</div><div class="bw l6 mono">SUPPORT</div><div class="bw l7">CONCLUSION</div>
      <div class="bw r1 mono">FORMAL REGISTER</div><div class="bw r2">OPINION ESSAY</div><div class="bw r3 mono">B2 · CAMBRIDGE</div><div class="bw r4">LINKING WORDS</div><div class="bw r5 mono">TOPIC SENTENCE</div><div class="bw r6">OWN IDEA ★</div><div class="bw r7 mono">140–190 WORDS</div>
      <div class="bw t2">ESSAY</div><div class="bw b2">WRITE</div>
      <div class="stat-block sb1"><div class="sb-inner"><span class="sb-num red">25%</span><span class="sb-item">CONTENT</span><span class="sb-num teal">25%</span><span class="sb-item">COMM. ACHIEVEMENT</span><span class="sb-num">25%</span><span class="sb-item">ORGANISATION</span><span class="sb-num">25%</span><span class="sb-item">LANGUAGE</span></div></div>
      <div class="stat-block sb2"><div class="sb-inner"><span class="sb-num">5</span><span class="sb-item">PARAGRAPHS</span><span class="sb-num red">190</span><span class="sb-item">MAX WORDS</span><span class="sb-num teal">3</span><span class="sb-item">BODY POINTS</span><span class="sb-num">1</span><span class="sb-item">OWN IDEA REQ.</span></div></div>
    </div>

    <div class="scene active" id="sc0">
      <div class="poster">
        <div class="flag"><div class="flag-body" id="sc0FlagBody" style="background:var(--red)"><span class="flag-num" id="sc0FlagLabel">ESSAY</span></div></div>
        <div class="section-lbl" id="sc0SectionLbl" style="color:var(--red)">B2 WRITING</div>
        <div style="padding:52px 24px 6px 26px;flex-shrink:0;">
          <div id="sc0Title" style="font-family:'Barlow Condensed',sans-serif;font-size:clamp(30px,5.5vw,42px);font-weight:900;line-height:.9;color:var(--ink);">HOW TO <span style="color:var(--red);">WRITE</span> AN ESSAY</div>
          <div id="sc0Tags" style="display:flex;gap:6px;flex-wrap:wrap;margin-top:8px;"></div>
        </div>
        <div id="sc0Structure" style="flex:1;min-height:0;padding:4px 26px 4px;display:flex;flex-direction:column;justify-content:center;gap:10px;overflow:hidden;"></div>
        <div class="card-dots-row"><button class="card-arrow" onclick="prevScene()" disabled>‹</button><div class="dots" id="dots0"></div><button class="card-arrow" onclick="nextScene()">›</button></div>
        <div class="accent-bar" id="sc0AccentBar" style="background:var(--red)"></div>
      </div>
    </div>

    <div class="scene" id="sc1">
      <div class="poster">
        <div class="flag"><div class="flag-body" id="sc1FlagBody" style="background:var(--c-intro)"><span class="flag-num" id="sc1FlagLabel">INTRODUCTION</span></div></div>
        <div class="section-lbl" id="sc1SectionLbl" style="color:var(--c-intro)">THE QUESTION</div>
        <div style="flex:1;min-height:0;display:flex;flex-direction:column;padding:54px 24px 10px;">
          <div id="sc1Kicker" style="font-family:'DM Mono',monospace;font-size:10px;letter-spacing:3px;text-transform:uppercase;color:var(--ink3);margin-bottom:12px;flex-shrink:0;"></div>
          <div id="sc1Question" style="font-family:'Barlow Condensed',sans-serif;font-size:clamp(28px,5vw,40px);font-weight:900;line-height:.95;color:var(--ink);flex-shrink:0;"></div>
          <div style="flex:1;"></div>
          <div id="sc1Extra" style="flex-shrink:0;margin-bottom:12px;"></div>
        </div>
        <div class="card-dots-row"><button class="card-arrow" onclick="prevScene()">‹</button><div class="dots" id="dots1"></div><button class="card-arrow" onclick="nextScene()">›</button></div>
        <div class="accent-bar" id="sc1AccentBar" style="background:var(--c-intro)"></div>
      </div>
    </div>

    <div class="scene" id="sc2">
      <div class="poster">
        <div class="flag"><div class="flag-body" style="background:var(--red)"><span class="flag-num" id="sc2FlagLabel">BODY PARAGRAPHS</span></div></div>
        <div class="section-lbl" style="color:var(--red)">STRUCTURE</div>
        <div id="sc2Idle" style="flex:1;min-height:0;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:46px 20px 12px;gap:6px;">
          <div id="sc2IdleTop" style="font-family:'DM Mono',monospace;font-size:9px;letter-spacing:3px;text-transform:uppercase;color:var(--ink3);">Each body paragraph has two parts</div>
          <div id="sc2IdleBig" style="font-family:'Barlow Condensed',sans-serif;font-size:clamp(44px,9vw,64px);font-weight:900;line-height:.86;text-align:center;color:var(--ink);">CLAIM<br><span style="color:var(--red);font-size:clamp(20px,4vw,28px);">+</span><br>SUPPORT</div>
          <div style="font-family:'DM Mono',monospace;font-size:9px;letter-spacing:2.5px;text-transform:uppercase;color:rgba(0,0,0,.22);text-align:center;margin-top:4px;">tap ▶ to learn what each part does</div>
        </div>
        <div id="sc2Build" style="flex:1;min-height:0;display:none;flex-direction:column;padding:46px 20px 6px;overflow:hidden;">
          <div id="sc2Kicker" style="font-family:'DM Mono',monospace;font-size:9px;letter-spacing:3px;text-transform:uppercase;color:var(--ink3);margin-bottom:6px;opacity:0;transition:opacity .4s;flex-shrink:0;">Each body paragraph has two parts</div>
          <div id="sc2ClaimBlock" style="flex-shrink:0;opacity:0;transform:translateY(14px);transition:opacity .35s,transform .4s cubic-bezier(.22,1,.36,1);"><div style="font-family:'Barlow Condensed',sans-serif;font-size:clamp(32px,7vw,48px);font-weight:900;line-height:.86;letter-spacing:1px;color:var(--ink);">CLAIM</div></div>
          <div id="sc2ClaimItems" style="flex-shrink:0;display:flex;flex-direction:column;gap:4px;margin-top:6px;margin-bottom:6px;padding-left:4px;border-left:3px solid var(--red);"></div>
          <div id="sc2Sep" style="flex-shrink:0;opacity:0;transition:opacity .3s;margin:2px 0 4px;"><div style="font-family:'Barlow Condensed',sans-serif;font-size:clamp(16px,3vw,22px);font-weight:900;color:var(--red);line-height:1;">+</div></div>
          <div id="sc2SupportBlock" style="flex-shrink:0;opacity:0;transform:translateY(14px);transition:opacity .35s,transform .4s cubic-bezier(.22,1,.36,1);"><div style="font-family:'Barlow Condensed',sans-serif;font-size:clamp(32px,7vw,48px);font-weight:900;line-height:.86;letter-spacing:1px;color:var(--ink);">SUPPORT</div></div>
          <div id="sc2SupportItems" style="flex-shrink:0;display:flex;flex-direction:column;gap:4px;margin-top:6px;padding-left:4px;border-left:3px solid rgba(28,28,30,.18);"></div>
        </div>
        <div class="card-dots-row"><button class="card-arrow" onclick="prevScene()">‹</button><div class="dots" id="dots2"></div><button class="card-arrow" onclick="nextScene()">›</button></div>
        <div class="accent-bar" style="background:var(--red)"></div>
      </div>
    </div>

    <div class="scene" id="sc3">
      <div class="poster">
        <div class="flag"><div class="flag-body" id="sc3FlagBody" style="background:var(--c-conc)"><span class="flag-num" id="sc3FlagLabel">CONCLUSION</span></div></div>
        <div class="section-lbl" id="sc3SectionLbl" style="color:var(--c-conc)">CONCLUSION</div>
        <div style="flex:1;min-height:0;display:flex;flex-direction:column;padding:54px 24px 6px;overflow:hidden;">
          <div style="font-family:'DM Mono',monospace;font-size:10px;letter-spacing:3px;text-transform:uppercase;color:rgba(0,0,0,.28);margin-bottom:10px;flex-shrink:0;" id="sc3KickerLbl">Paragraph 5 · Conclusion</div>
          <div id="conclSkeleton" style="display:flex;flex-direction:column;gap:8px;flex-shrink:0;">
            <div style="display:flex;align-items:center;gap:10px;opacity:.22;"><div style="font-family:'DM Mono',monospace;font-size:9px;letter-spacing:1.5px;text-transform:uppercase;padding:2px 8px;border-radius:2px;border-left:2.5px solid var(--red);background:rgba(201,20,15,.07);color:var(--red);white-space:nowrap;">SUMMARY</div><div style="flex:1;height:10px;background:rgba(0,0,0,.08);border-radius:3px;"></div></div>
            <div style="display:flex;align-items:center;gap:10px;opacity:.18;"><div style="font-family:'DM Mono',monospace;font-size:9px;letter-spacing:1.5px;text-transform:uppercase;padding:2px 8px;border-radius:2px;border-left:2.5px solid var(--red);background:rgba(201,20,15,.07);color:var(--red);white-space:nowrap;">POINT 1</div><div style="flex:1;height:10px;background:rgba(0,0,0,.08);border-radius:3px;"></div></div>
            <div style="display:flex;align-items:center;gap:10px;opacity:.14;"><div style="font-family:'DM Mono',monospace;font-size:9px;letter-spacing:1.5px;text-transform:uppercase;padding:2px 8px;border-radius:2px;border-left:2.5px solid var(--red);background:rgba(201,20,15,.07);color:var(--red);white-space:nowrap;">POINT 2</div><div style="flex:1;height:10px;background:rgba(0,0,0,.08);border-radius:3px;"></div></div>
            <div style="display:flex;align-items:center;gap:10px;opacity:.10;"><div style="font-family:'DM Mono',monospace;font-size:9px;letter-spacing:1.5px;text-transform:uppercase;padding:2px 8px;border-radius:2px;border-left:2.5px solid var(--red);background:rgba(201,20,15,.07);color:var(--red);white-space:nowrap;">REWORD</div><div style="flex:1;height:10px;background:rgba(0,0,0,.08);border-radius:3px;"></div></div>
            <div style="display:flex;align-items:center;gap:10px;opacity:.07;"><div style="font-family:'DM Mono',monospace;font-size:9px;letter-spacing:1.5px;text-transform:uppercase;padding:2px 8px;border-radius:2px;border-left:2.5px solid var(--red);background:rgba(201,20,15,.07);color:var(--red);white-space:nowrap;">VERDICT</div><div style="flex:1;height:10px;background:rgba(0,0,0,.08);border-radius:3px;"></div></div>
          </div>
          <div id="conclHint" style="margin-top:14px;flex-shrink:0;font-family:'DM Mono',monospace;font-size:10px;letter-spacing:2px;text-transform:uppercase;color:rgba(0,0,0,.2);text-align:center;">tap ▶ to build this paragraph</div>
          <div class="sentence-scroll" id="stk3"></div>
        </div>
        <div class="card-dots-row"><button class="card-arrow" onclick="prevScene()">‹</button><div class="dots" id="dots3"></div><button class="card-arrow" onclick="nextScene()" disabled>›</button></div>
        <div class="accent-bar" id="sc3AccentBar" style="background:var(--c-conc)"></div>
      </div>
    </div>
  </div>

  <div class="footer" id="mainFooter">
    <div class="tab-bar-wrap">
      <div class="tab-bar">
        <button class="tab-btn active" data-tab="intro" onclick="jumpTab('intro')">INTRODUCTION</button>
        <button class="tab-btn" data-tab="body" onclick="jumpTab('body')">BODY</button>
        <button class="tab-btn" data-tab="conc" onclick="jumpTab('conc')">CONCLUSION</button>
        <button class="tab-btn" data-tab="notes" onclick="jumpTab('notes')">USEFUL NOTES</button>
      </div>
    </div>
  </div>

  <div class="play-cluster" id="playCluster">
    <div class="wave-mini off" id="wL"><div class="wb"></div><div class="wb"></div><div class="wb"></div><div class="wb"></div><div class="wb"></div></div>
    <button class="btn-nav" id="btnPrev" onclick="prevScene()" disabled>‹</button>
    <button class="btn-play-inline" id="btnPlay" onclick="handlePlay()">▶</button>
    <button class="btn-nav" id="btnNext" onclick="nextScene()">›</button>
    <div class="wave-mini off" id="wR"><div class="wb"></div><div class="wb"></div><div class="wb"></div><div class="wb"></div><div class="wb"></div></div>
  </div>
</div>

<!-- PHRASE BANK -->
<div class="pb-ov" id="pbOv">
  <div class="pb-header">
    <div class="pb-hflag"><span>BODY PARAGRAPHS · PHRASE BANK</span></div>
    <div class="pb-htitle">Every phrase you need — in one poster</div>
    <div class="pb-hsub">Read all options · Choose what fits</div>
    <div class="pb-hstop"><button class="pb-stop-btn" onclick="hardStop();updateNavBtns()">⏹ STOP</button></div>
  </div>
  <div class="pb-body">
    <div class="pb-col left">
      <div class="pb-col-head"><div class="pb-col-word red">CLAIM</div><div class="pb-col-desc">Open your paragraph.<br>State your point.</div></div>
      <div class="pb-cats">
        <div class="pb-cat"><div class="pb-cat-bar" style="background:#c9140f;"></div><div class="pb-cat-body"><div class="pb-cat-label" style="color:#c9140f;">Listing Marker</div><div class="pb-cat-pills"><span class="pb-pill hi">Firstly,</span><span class="pb-pill hi">Furthermore,</span><span class="pb-pill hi">In addition,</span><span class="pb-pill hi">However,</span><span class="pb-pill hi">On the other hand,</span></div></div></div>
        <div class="pb-cat"><div class="pb-cat-bar" style="background:#1a5c8a;"></div><div class="pb-cat-body"><div class="pb-cat-label" style="color:#1a5c8a;">Expressing a View</div><div class="pb-cat-pills"><span class="pb-pill hi">in my opinion,</span><span class="pb-pill hi">it seems to me that</span><span class="pb-pill hi">as far as I am concerned,</span><span class="pb-pill">I firmly believe that</span><span class="pb-pill">It is widely believed that</span></div></div></div>
        <div class="pb-cat"><div class="pb-cat-bar" style="background:#1a6b3c;"></div><div class="pb-cat-body"><div class="pb-cat-label" style="color:#1a6b3c;">Making a Claim</div><div class="pb-cat-pills"><span class="pb-pill hi">the main advantage of … is</span><span class="pb-pill hi">one key problem with … is</span><span class="pb-pill">The key benefit of … is</span><span class="pb-pill">One clear drawback is…</span><span class="pb-pill">An important point is…</span></div></div></div>
      </div>
    </div>
    <div class="pb-col">
      <div class="pb-col-head"><div class="pb-col-word">SUPPORT</div><div class="pb-col-desc">Develop your claim.<br>Use what fits best.</div></div>
      <div class="pb-cats">
        <div class="pb-cat"><div class="pb-cat-bar" style="background:#1a6b3c;"></div><div class="pb-cat-body"><div class="pb-cat-label" style="color:#1a6b3c;">Reason — why?</div><div class="pb-cat-pills"><span class="pb-pill hi">This is because…</span><span class="pb-pill hi">The reason is that…</span><span class="pb-pill">This is largely due to…</span><span class="pb-pill">Since…</span></div></div></div>
        <div class="pb-cat"><div class="pb-cat-bar" style="background:#1a5c8a;"></div><div class="pb-cat-body"><div class="pb-cat-label" style="color:#1a5c8a;">Example — evidence</div><div class="pb-cat-pills"><span class="pb-pill hi">For example,</span><span class="pb-pill hi">For instance,</span><span class="pb-pill">Indeed,</span><span class="pb-pill">This can be seen in…</span></div></div></div>
        <div class="pb-cat"><div class="pb-cat-bar" style="background:#6b4ea8;"></div><div class="pb-cat-body"><div class="pb-cat-label" style="color:#6b4ea8;">Result — consequence</div><div class="pb-cat-pills"><span class="pb-pill hi">As a result,</span><span class="pb-pill hi">Consequently,</span><span class="pb-pill hi">Therefore,</span><span class="pb-pill">This means that…</span></div></div></div>
        <div class="pb-cat"><div class="pb-cat-bar" style="background:#e07b00;"></div><div class="pb-cat-body"><div class="pb-cat-label" style="color:#e07b00;">Contrast / Compare</div><div class="pb-cat-pills"><span class="pb-pill hi">Although…</span><span class="pb-pill hi">However,</span><span class="pb-pill">Even though…</span><span class="pb-pill">While…</span><span class="pb-pill">Unlike…</span><span class="pb-pill">In other words,</span></div></div></div>
      </div>
    </div>
  </div>
  <div class="pb-foot"></div>
</div>

<!-- LISTING MARKERS -->
<div class="listing-ov" id="listingOv">
  <div class="listing-header">
    <div class="listing-hflag"><span>LISTING MARKERS</span></div>
    <div class="listing-htitle">Open each paragraph differently</div>
    <div class="listing-hsub">Never repeat the same marker</div>
  </div>
  <div class="listing-kicker-row">
    <div class="listing-kicker-big">Choose a <em>different</em> one for each paragraph.</div>
    <div class="listing-sub-text">Marker → opinion phrase → your claim.</div>
  </div>
  <div class="listing-rows" id="listingRows"></div>
  <div class="listing-foot"></div>
</div>

<!-- INTRO PAIRS -->
<div class="poster-ov" id="introOv" onclick="if(event.target===this){hardStop();updateNavBtns();}">
  <div class="pov-pillar left"><span class="pov-pillar-text">INTRODUCTION · HOOK + THESIS</span></div>
  <div class="pov-pillar right"><span class="pov-pillar-text">1 EXAMPLE · FOLLOW THE PATTERN</span></div>
  <div class="pov-card" id="introCard">
    <div class="pov-flag"><div class="pov-flag-body" style="background:var(--c-intro)"><span class="pov-flag-num">INTRODUCTION</span></div></div>
    <div class="pov-pair-lbl" id="introNum">1 / 1</div>
    <div class="pov-intro-body">
      <div class="ob-hlbl">🪝 HOOK</div>
      <div class="ob-starter" id="obS"></div>
      <div class="ob-rest" id="obR"></div>
      <div class="ob-link" id="obL"></div>
      <div class="ob-sep"></div>
      <div><div class="ob-tlbl">📌 THESIS</div><div class="ob-tt" id="obT"></div></div>
    </div>
    <div class="pov-card-foot"><button class="pov-stop-btn" onclick="hardStop();updateNavBtns()">⏹ STOP</button></div>
    <div class="pov-bottom-bar" style="background:var(--c-intro)"></div>
  </div>
  <div class="pov-dots" id="introDots"></div>
</div>

<!-- BODY PAIRS -->
<div class="poster-ov" id="bodyOv" onclick="if(event.target===this){hardStop();updateNavBtns();}">
  <div class="pov-pillar left"><span class="pov-pillar-text" id="bodyPillarLeft">BODY PARAGRAPH 1 · P2</span></div>
  <div class="pov-pillar right"><span class="pov-pillar-text" id="bodyPillarRight">CLAIM + SUPPORT + RESULT</span></div>
  <div class="pov-card" id="bodyCard">
    <div class="pov-flag"><div class="pov-flag-body" id="bodyFlagBody"><span class="pov-flag-num" id="bodyFlagNum">BODY PARAGRAPH 1</span></div></div>
    <div class="pov-pair-lbl" id="bodyNum">1 / 3</div>
    <div class="pov-body-body" id="bodyCardBody"></div>
    <div class="pov-card-foot"><button class="pov-stop-btn" onclick="hardStop();updateNavBtns()">⏹ STOP</button></div>
    <div class="pov-bottom-bar" id="bodyBottomBar"></div>
  </div>
  <div class="pov-dots" id="bodyDots"></div>
</div>

<!-- INTERSTITIAL -->
<div class="inter-ov" id="interOv">
  <div class="inter-card">
    <div class="inter-flag"><div class="inter-flag-body" id="interFlagBody"><span class="inter-flag-num" id="interFlagNum"></span></div></div>
    <div class="inter-section-lbl" id="interSectionLbl"></div>
    <div class="inter-body">
      <div class="inter-kicker" id="interKicker"></div>
      <div class="inter-big" id="interBig"></div>
      <div class="inter-sub" id="interSub"></div>
    </div>
    <div class="inter-bottom" id="interBottom"></div>
  </div>
</div>

<!-- NOTES -->
<div class="notes-panel" id="notesPanel">
  <div class="notes-card">
    <div class="notes-top"></div>
    <div class="notes-header"><div class="notes-title">📋 USEFUL NOTES</div><button class="notes-close" onclick="closeNotes()">✕ Close</button></div>
    <div class="notes-tabs">
      <button class="ntab on" data-ntab="descriptors" onclick="switchNtab('descriptors')">📋 Descriptors</button>
      <button class="ntab" data-ntab="linking" onclick="switchNtab('linking')">🔗 Linking Words</button>
      <button class="ntab" data-ntab="phrases" onclick="switchNtab('phrases')">💬 All Phrases</button>
      <button class="ntab" data-ntab="planning" onclick="switchNtab('planning')">📝 Planning</button>
      <button class="ntab" data-ntab="wordlimit" onclick="switchNtab('wordlimit')">🔢 Word Limit</button>
    </div>
    <div class="notes-body" id="notesBody"></div>
  </div>
</div>

<div class="flash" id="flash"></div>

<!-- SECONDARY MODAL -->
<div class="sm-backdrop" id="smBackdrop" onclick="closeSecModal()"></div>
<div class="sm-wrap" id="smWrap">
  <div class="sm-card" id="smCard">
    <div class="sm-flag"><div class="sm-flag-body" id="smFlagBody"><span class="sm-flag-txt" id="smFlagTxt"></span></div></div>
    <div class="sm-section-lbl" id="smSectionLbl"></div>
    <div class="sm-body"><div class="sm-title" id="smTitle"></div><div class="sm-divider"></div><div id="smPhrases"></div></div>
    <div class="sm-foot-row"><div class="sm-timer-bar-wrap"><div class="sm-timer-bar" id="smTimerBar"></div></div></div>
    <div class="sm-accent-bar" id="smAccentBar"></div>
  </div>
</div>

<script>
// ══════════════════════════════════════════════════════════════════════════════
// MP3 AUDIO ENGINE
// All 110 Audio objects created on first user gesture (initAudioPool).
// Each skill has an offset so speak(t, myGen, n) resolves to the correct file:
//   essay  : n + 0   → files 01–30
//   report : n + 30  → files 31–60
//   review : n + 60  → files 61–90
//   email  : n + 90  → files 91–110
// ══════════════════════════════════════════════════════════════════════════════
const MP3_OFFSETS = { essay: 0, report: 30, review: 60, email: 90 };
const MP3_BASE    = './data/';
const MP3_TOTAL   = 110;

let mp3Pool    = null;   // created once on first gesture
let mp3Active  = null;
let mp3Resolve = null;
let mp3Offset  = 0;      // set by launchSkill()

function initAudioPool() {
  if (mp3Pool) return;
  mp3Pool = [];
  for (let i = 1; i <= MP3_TOTAL; i++) {
    const a = new Audio(MP3_BASE + String(i).padStart(2, '0') + '.mp3.mp3');
    a.preload = 'none';
    mp3Pool.push(a);
  }
}

function stopSpeech() {
  if (mp3Active) {
    mp3Active.pause();
    mp3Active.currentTime = 0;
    mp3Active.onended = null;
    mp3Active.onerror = null;
    mp3Active = null;
  }
  if (mp3Resolve) { mp3Resolve(); mp3Resolve = null; }
}

function loadVoice() {} // compatibility stub — no-op

// speak(text, myGen, n)
//   n  = 1-based LOCAL file number for this skill (offset applied automatically)
//   If n is omitted the call is a silent pass-through (useful as placeholder).
function speak(t, myGen, n) {
  return new Promise(resolve => {
    if (!running || myGen !== gen) { resolve(); return; }
    stopSpeech();
    if (!mp3Pool || n === undefined) { resolve(); return; }
    const globalN = n + mp3Offset;
    if (globalN < 1 || globalN > MP3_TOTAL) { console.warn('speak: out of range n=' + globalN); resolve(); return; }
    const audio = mp3Pool[globalN - 1];
    audio.currentTime = 0;
    mp3Active  = audio;
    mp3Resolve = resolve;
    audio.onended = () => { mp3Active = null; mp3Resolve = null; resolve(); };
    audio.onerror = () => { console.warn('MP3 error n=' + globalN); mp3Active = null; mp3Resolve = null; resolve(); };
    audio.play().catch(e => { console.warn('play() blocked:', e.message); mp3Active = null; mp3Resolve = null; resolve(); });
  });
}
// ══════════════════════════════════════════════════════════════════════════════

// ══ SKILL DATA ══
let SKILLS = null;

async function loadSkills() {
  try {
    const res = await fetch('writing-data.json');
    SKILLS = await res.json();
  } catch(e) {
    document.getElementById('skillScreen').innerHTML += `<div style="font-family:'DM Mono',monospace;font-size:11px;color:#c9140f;margin-top:12px;">Could not load writing-data.json</div>`;
    console.error('Failed to load skill data:', e);
  }
}
loadSkills();

let SK = null; // active skill

function launchSkill(key) {
  // Initialise audio pool on this gesture so iOS grants autoplay to all 110 objects
  initAudioPool();

  SK = SKILLS[key];
  // Set MP3 offset for this skill
  mp3Offset = MP3_OFFSETS[key] || 0;

  // Update logo
  document.getElementById('logoEl').innerHTML = SK.logoHtml;

  // SC0 — overview card
  const sc0Color = SK.accentColor;
  document.getElementById('sc0FlagBody').style.background = sc0Color;
  document.getElementById('sc0FlagLabel').textContent = SK.sc0FlagLabel;
  document.getElementById('sc0AccentBar').style.background = sc0Color;
  document.getElementById('sc0SectionLbl').style.color = sc0Color;
  document.getElementById('sc0Title').innerHTML = `HOW TO <span style="color:${sc0Color};">WRITE</span> A${SK.sc0TitleSuffix}`;
  document.getElementById('sc0Tags').innerHTML = SK.sc0Tags.map((t,i) =>
    `<span style="font-family:'DM Mono',monospace;font-size:9px;padding:3px 9px;border-radius:20px;text-transform:uppercase;background:${i===0?sc0Color+'18':'rgba(0,0,0,.05)'};color:${i===0?sc0Color:'var(--ink3)'};border:1px solid ${i===0?sc0Color+'22':'var(--border)'}">${t}</span>`
  ).join('');
  document.getElementById('sc0Structure').innerHTML = SK.sc0Structure.map(s =>
    `<div style="display:flex;align-items:baseline;gap:14px;flex-shrink:0;">
      <div style="font-family:'Barlow Condensed',sans-serif;font-size:18px;font-weight:900;color:${s.c};min-width:26px;">${s.p}</div>
      <div>
        <div style="font-family:'Barlow Condensed',sans-serif;font-size:19px;font-weight:900;color:var(--ink);">${s.label}</div>
        <div style="font-family:'Instrument Sans',sans-serif;font-size:12px;color:var(--ink3);margin-top:1px;">${s.sub}</div>
      </div>
    </div>`
  ).join('');

  // SC1 — question card
  document.getElementById('sc1FlagBody').style.background = SK.accentColor;
  document.getElementById('sc1FlagLabel').textContent = SK.sc1FlagLabel;
  document.getElementById('sc1SectionLbl').textContent = SK.sc1SectionLbl;
  document.getElementById('sc1SectionLbl').style.color = SK.accentColor;
  document.getElementById('sc1Kicker').textContent = SK.sc1Kicker;
  document.getElementById('sc1Question').innerHTML = SK.sc1Question;
  document.getElementById('sc1Extra').innerHTML = SK.sc1Extra;
  document.getElementById('sc1AccentBar').style.background = SK.accentColor;

  // SC2 idle labels
  document.getElementById('sc2IdleTop').textContent = SK.sc2IdleTop || 'Each body paragraph has two parts';
  document.getElementById('sc2IdleBig').innerHTML = SK.sc2IdleBig || 'CLAIM<br><span style="color:var(--red);font-size:clamp(20px,4vw,28px);">+</span><br>SUPPORT';

  // Show player
  document.getElementById('skillScreen').classList.add('out');
  document.getElementById('playerShell').style.visibility = 'visible';
  document.getElementById('backPill').style.display = 'block';

  // Reset state
  cur = 0; running = false; introOvOn = false; bodyOvOn = false; pbOvOn = false; gen = 0;
  clearStacks(); buildDots(); updateDots(0); showScene(0); updateNavBtns();
  requestAnimationFrame(updateFooterVar);
}

function goBack() {
  hardStop();
  document.getElementById('playerShell').style.visibility = 'hidden';
  document.getElementById('backPill').style.display = 'none';
  document.getElementById('skillScreen').classList.remove('out');
  SK = null;
}

const SCENE_COUNT = 4;

function updateFooterVar() {
  const f  = document.getElementById('mainFooter');
  const tb = document.querySelector('.topbar');
  if (f) {
    const fh  = f.offsetHeight;
    const tbh = tb ? tb.offsetHeight : 0;
    document.documentElement.style.setProperty('--footer-h', fh + 'px');
    document.documentElement.style.setProperty('--stage-h', (window.innerHeight - fh - tbh) + 'px');
  }
}

// ══ NOTES DATA ══
const NOTES_DATA = {
  descriptors:[
    {title:'Content (25%)',items:['<strong>Answer the question directly.</strong> Include both given ideas plus your own third idea.','Each point must be developed — not just stated.','Missing the third idea = automatic loss of marks.']},
    {title:'Communicative Achievement (25%)',items:['<strong>Formal register throughout.</strong> No contractions, no slang.','Every claim needs a reason or example.','Never "I think" — use "In my opinion" or "It seems to me that".']},
    {title:'Organisation (25%)',items:['<strong>Clear paragraphs</strong> with a topic sentence in each.','Logical: claim → reason → example → result.','Different linking word to begin each paragraph.']},
    {title:'Language (25%)',items:['<strong>Range of vocabulary</strong> — avoid repetition.','Variety of grammar: passive, relative clauses, conditionals.','Accurate spelling and punctuation.']}
  ],
  linking:[
    {title:'Opening — DIFFERENT one each time',items:['<strong>Firstly,</strong> · <strong>Furthermore,</strong> · <strong>In addition,</strong> · <strong>However,</strong> · <strong>On the other hand,</strong>','⚠️ Never use "Secondly," in a B2 essay.','⚠️ Never repeat the same opening marker.']},
    {title:'Expressing a view',items:['it seems to me · In my opinion, · As far as I am concerned,','It is widely believed · I firmly believe that']},
    {title:'Reason',items:['This is because… · This is largely due to… · Since… · The reason is that…']},
    {title:'Example',items:['For example, · For instance, · Indeed, · This can be seen in…']},
    {title:'Result',items:['As a result, · Consequently, · Therefore, · This means that…']},
    {title:'Contrast',items:['Although… · Even though… · Despite… · However,']},
    {title:'Concluding',items:['In conclusion, · To sum up, · All things considered, · On balance,']}
  ],
  planning:[
    {title:'The 5-minute exam plan',items:['<strong>Read twice.</strong> Underline the two given ideas.','Decide: agree / disagree / balanced.','Jot 2–3 keywords per paragraph — not full sentences.','Decide your OWN third idea BEFORE you start writing.']},
    {title:'What every body paragraph needs',items:['<strong>A clear claim</strong> — open with a listing marker + your point.','<strong>Support</strong> — a reason, an example, a result. Use what fits.','Two or three sentences of support is enough.']},
    {title:'Common mistakes',items:['Starting without knowing what your own third idea will be.','Copying phrases from the question — always rephrase.','Using the same opening marker in two paragraphs.']}
  ],
  phrases:[
    {title:'CLAIM — Listing marker',items:['Firstly,','Furthermore,','In addition,','However,','On the other hand,']},
    {title:'CLAIM — Expressing a view',items:['in my opinion,','it seems to me that','as far as I am concerned,','I firmly believe that']},
    {title:'CLAIM — Making a claim',items:['the main advantage of … is','one key problem with … is','An important point is…']},
    {title:'SUPPORT — Reason',items:['This is because…','The reason is that…','Since…']},
    {title:'SUPPORT — Example',items:['For example,','For instance,','This can be seen in…']},
    {title:'SUPPORT — Result',items:['As a result,','Consequently,','Therefore,']},
    {title:'SUPPORT — Contrast',items:['Although…','However,','Even though…','In other words,']}
  ],
  wordlimit:[
    {title:'Target: 140–190 words',items:['<strong>Under 130 = automatic mark penalty.</strong>','190 words = roughly 12–15 sentences across 5 paragraphs.','Intro 2–3 · Each body 3–4 · Conclusion 2–3.']},
    {title:'Quick fixes if too short',items:['Add a result sentence to each body paragraph.','Expand your example with a specific detail.','Add a concession in P4: "While some argue that… I believe…"']}
  ]
};

// ══ SKILL DATA ACCESSORS ══
function getPAIRS()      { return SK ? SK.pairs      : []; }
function getBODY_PAIRS() { return SK ? SK.bodyPairs  : []; }
function getCONCL_DATA() { return SK ? SK.conclData  : []; }

const LISTING_MARKERS = [
  {marker:'Firstly,',color:'#c9140f',label:'TO INTRODUCE',example:'<em>Firstly,</em> in my opinion, the main benefit of limiting phones is better sleep.'},
  {marker:'Furthermore,',color:'#1a6b3c',label:'TO ADD A POINT',example:'<em>Furthermore,</em> it seems to me that phone use affects concentration in class.'},
  {marker:'In addition,',color:'#1a5c8a',label:'TO ADD MORE',example:'<em>In addition,</em> as far as I am concerned, phones can damage social skills.'},
  {marker:'However,',color:'#e07b00',label:'TO CONTRAST',example:'<em>However,</em> some people believe that phones are useful for learning.'},
  {marker:'On the other hand,',color:'#6b4ea8',label:'TO CONTRAST',example:'<em>On the other hand,</em> smartphones give students access to a great deal of information.'}
];

// ══ RUNTIME STATE ══
let cur=0, running=false, introOvOn=false, bodyOvOn=false, pbOvOn=false, gen=0;

function hardStop() {
  gen++; running=false; introOvOn=false; bodyOvOn=false; pbOvOn=false;
  stopSpeech(); waveOff();
  ['introOv','bodyOv','pbOv','listingOv','interOv'].forEach(id => document.getElementById(id).classList.remove('show'));
  document.getElementById('introCard').classList.remove('exit');
  document.getElementById('bodyCard').classList.remove('exit');
  closeSecModal();
  const b = document.getElementById('btnPlay');
  if (b) { b.textContent = '▶'; b.classList.remove('running'); }
}

function wait(ms, myGen) {
  return new Promise(r => setTimeout(() => r(), (myGen !== undefined && myGen !== gen) ? 0 : ms));
}

function buildDots() {
  for (let sc=0; sc<SCENE_COUNT; sc++) {
    const c = document.getElementById('dots'+sc); if (!c) continue; c.innerHTML='';
    for (let i=0; i<SCENE_COUNT; i++) { const d=document.createElement('div'); d.className='dot'; d.id='d'+sc+'-'+i; c.appendChild(d); }
  }
}
function updateDots(i) {
  for (let sc=0; sc<SCENE_COUNT; sc++) {
    for (let j=0; j<SCENE_COUNT; j++) {
      const d=document.getElementById('d'+sc+'-'+j); if (!d) continue;
      d.classList.remove('active','done');
      if (j===i) d.classList.add('active'); else if (j<i) d.classList.add('done');
    }
  }
}

const SECTION_END = {intro:1, body:2, conc:3};
let activeSection = 'intro';
function sectionForScene(idx) { if (idx<=1) return 'intro'; if (idx<=2) return 'body'; return 'conc'; }
function syncTab(idx) { const t=sectionForScene(idx); document.querySelectorAll('.tab-btn').forEach(b=>b.classList.toggle('active',b.dataset.tab===t)); }

function jumpTab(tab) {
  if (tab==='notes') { openNotes(); return; }
  initAudioPool();
  hardStop(); clearStacks();
  const map={intro:0, body:2, conc:3};
  const target=map[tab];
  if (typeof target==='number') {
    activeSection=tab; cur=target;
    showScene(cur);
    setTimeout(() => {
      if (!running) { running=true; const myGen=gen; const b=document.getElementById('btnPlay'); b.textContent='⏹'; b.classList.add('running'); updateNavBtns(); runScene(cur,myGen); }
    }, 120);
  }
  updateNavBtns();
}

function showScene(i) {
  document.querySelectorAll('.scene').forEach(s=>s.classList.remove('active'));
  const sc=document.getElementById('sc'+i); if (!sc) return;
  sc.classList.add('active');
  document.getElementById('ctr').textContent=(i+1)+' / '+SCENE_COUNT;
  updateDots(i); syncTab(i); updateNavBtns(); flashColor(); if (i>0) spawnEmoji(i);
}
function waveOn()  { ['wL','wR'].forEach(id=>{const w=document.getElementById(id);if(w){w.classList.remove('off');w.classList.add('on');}}); }
function waveOff() { ['wL','wR'].forEach(id=>{const w=document.getElementById(id);if(w){w.classList.remove('on');w.classList.add('off');}}); }

function showInter(flag,fc,kicker,big,sub,ac) {
  document.getElementById('interFlagBody').style.background=fc;
  document.getElementById('interFlagNum').textContent=flag;
  document.getElementById('interKicker').textContent=kicker;
  document.getElementById('interBig').innerHTML=big;
  document.getElementById('interSub').innerHTML=sub;
  document.getElementById('interBottom').style.background=fc;
  document.getElementById('interSectionLbl').textContent=kicker;
  document.getElementById('interOv').style.setProperty('--inter-accent',ac||fc);
  document.getElementById('interOv').classList.add('show');
}
function hideInter() { document.getElementById('interOv').classList.remove('show'); }
function showPhraseBank() { pbOvOn=true; document.getElementById('pbOv').classList.add('show'); }
function showListing() {
  const el=document.getElementById('listingRows'); el.innerHTML='';
  LISTING_MARKERS.forEach(m=>{
    const row=document.createElement('div'); row.className='listing-row';
    row.innerHTML=`<div class="listing-row-marker" style="color:${m.color};background:${m.color}12;">${m.marker}</div><div class="listing-row-mid"><div class="listing-row-mid-label" style="color:${m.color};">${m.label}</div></div><div class="listing-row-example">${m.example}</div>`;
    el.appendChild(row);
  });
  document.getElementById('listingOv').classList.add('show');
}

// ══ INTRO PAIRS ══
async function runIntroPairs(myGen) {
  const PAIRS=getPAIRS();
  introOvOn=true;
  document.getElementById('introDots').innerHTML=PAIRS.map((_,i)=>`<div class="bdot" id="bd${i}"></div>`).join('');
  document.getElementById('introOv').classList.add('show');
  for (let i=0;i<PAIRS.length;i++) { if (!running||!introOvOn||myGen!==gen) break; await showIntroPair(PAIRS[i],i,myGen); }
  document.getElementById('introOv').classList.remove('show');
  document.getElementById('introCard').classList.remove('exit');
  introOvOn=false;
}
async function showIntroPair(p,idx,myGen) {
  const PAIRS=getPAIRS();
  const card=document.getElementById('introCard');
  if (idx>0) { card.classList.add('exit'); await wait(190,myGen); if (!running||!introOvOn||myGen!==gen){card.classList.remove('exit');return;} card.classList.remove('exit'); }
  if (!running||!introOvOn||myGen!==gen) return;
  document.getElementById('introNum').textContent=(idx+1)+' / '+PAIRS.length;
  const sEl=document.getElementById('obS'); sEl.textContent=p.s;
  const l=p.s.length; sEl.style.fontSize=l>22?'clamp(2.2rem,6vw,4rem)':l>14?'clamp(3rem,8vw,5.5rem)':'clamp(4rem,10vw,7rem)';
  const rEl=document.getElementById('obR'),lEl=document.getElementById('obL'),tEl=document.getElementById('obT');
  rEl.style.cssText='opacity:0;transform:translateY(6px);transition:none;';
  lEl.style.cssText='opacity:0;transform:translateY(4px);transition:none;';
  tEl.style.cssText='opacity:0;transform:translateY(8px);transition:none;';
  rEl.textContent=p.r; lEl.innerHTML=p.linkHtml; tEl.innerHTML=p.t;
  await wait(24,myGen); rEl.style.cssText=''; lEl.style.cssText=''; tEl.style.cssText='';
  for (let i=0;i<PAIRS.length;i++){const d=document.getElementById('bd'+i);if(d){d.classList.toggle('active',i===idx);d.classList.toggle('done',i<idx);}}
  waveOn();
  // p.audioNums = [hookN, linkN, thesisN] — 1-based local file numbers
  if (p.audioNums) {
    await speak(p.f,  myGen, p.audioNums[0]); if (!running||!introOvOn||myGen!==gen) return;
    await wait(140,myGen);
    await speak(p.link, myGen, p.audioNums[1]); if (!running||!introOvOn||myGen!==gen) return;
    await wait(140,myGen);
    await speak(p.tf, myGen, p.audioNums[2]); if (!running||!introOvOn||myGen!==gen) return;
  }
  waveOff(); await wait(460,myGen);
}

// ══ BODY PAIRS ══
async function runBodyPairs(myGen) {
  const BODY_PAIRS=getBODY_PAIRS();
  bodyOvOn=true;
  document.getElementById('bodyCardBody').innerHTML='';
  document.getElementById('bodyFlagNum').textContent='';
  document.getElementById('bodyDots').innerHTML=BODY_PAIRS.map((_,i)=>`<div class="bdot" id="bbd${i}"></div>`).join('');
  const bodyOvEl=document.getElementById('bodyOv');
  bodyOvEl.classList.remove('show');
  document.getElementById('bodyCard').classList.remove('exit');
  await wait(40,myGen); if (!running||myGen!==gen) return;
  bodyOvEl.classList.add('show');
  for (let i=0;i<BODY_PAIRS.length;i++) { if (!running||!bodyOvOn||myGen!==gen) break; await showBodyPair(BODY_PAIRS[i],i,myGen); }
  document.getElementById('bodyOv').classList.remove('show');
  document.getElementById('bodyCard').classList.remove('exit');
  bodyOvOn=false;
}
async function showBodyPair(para,idx,myGen) {
  const BODY_PAIRS=getBODY_PAIRS();
  const card=document.getElementById('bodyCard');
  if (idx>0) {
    card.classList.add('exit'); await wait(190,myGen);
    if (!running||!bodyOvOn||myGen!==gen){card.classList.remove('exit');return;}
    card.classList.remove('exit');
    if (idx===2 && para.ownIdeaNarration) {
      waveOn();
      await speak(para.ownIdeaNarration, myGen, para.ownIdeaN);
      if (!running||!bodyOvOn||myGen!==gen){waveOff();return;}
      await wait(300,myGen); if (!running||!bodyOvOn||myGen!==gen) return;
    }
  }
  if (!running||!bodyOvOn||myGen!==gen) return;
  document.getElementById('bodyNum').textContent=(idx+1)+' / '+BODY_PAIRS.length;
  document.getElementById('bodyFlagNum').textContent=para.flagTitle;
  document.getElementById('bodyFlagBody').style.background=para.color;
  document.getElementById('bodyBottomBar').style.background=para.color;
  document.getElementById('bodyPillarLeft').textContent=para.flagTitle+' · P'+(idx+2);
  document.getElementById('bodyPillarRight').textContent=idx===2?'YOUR OWN IDEA ★':'CLAIM + SUPPORT + RESULT';
  for (let i=0;i<BODY_PAIRS.length;i++){const d=document.getElementById('bbd'+i);if(d){d.classList.toggle('active',i===idx);d.classList.toggle('done',i<idx);}}
  const body=document.getElementById('bodyCardBody'); body.innerHTML='';
  const topicLbl=document.createElement('div');
  topicLbl.style.cssText=`font-family:"DM Mono",monospace;font-size:12px;letter-spacing:2.5px;text-transform:uppercase;margin-bottom:16px;flex-shrink:0;color:${para.color};`;
  topicLbl.textContent=para.topic; body.appendChild(topicLbl);
  const claimRow=document.createElement('div');
  claimRow.style.cssText='display:flex;align-items:baseline;gap:12px;flex-wrap:wrap;flex-shrink:0;margin-bottom:14px;';
  const sLen=para.starter.length;
  const sFontSize=sLen>16?'clamp(2.4rem,6vw,3.6rem)':sLen>10?'clamp(3rem,8vw,5rem)':'clamp(3.8rem,10vw,6.5rem)';
  const starterEl=document.createElement('span');
  starterEl.style.cssText=`font-family:"Barlow Condensed",sans-serif;font-size:${sFontSize};font-weight:900;line-height:.88;letter-spacing:.5px;color:var(--ink);`;
  starterEl.textContent=para.starter; claimRow.appendChild(starterEl);
  if (para.opinion){const opEl=document.createElement('span');opEl.style.cssText=`font-family:"Instrument Sans",sans-serif;font-size:clamp(14px,2vw,18px);font-weight:500;font-style:italic;color:${para.color};line-height:1;`;opEl.textContent=para.opinion;claimRow.appendChild(opEl);}
  body.appendChild(claimRow);
  if (para.keyExpr){const keyEl=document.createElement('div');keyEl.style.cssText=`font-family:"DM Mono",monospace;font-size:clamp(11px,1.5vw,14px);font-weight:500;letter-spacing:.5px;color:#fff;background:${para.color};display:inline-block;padding:6px 14px;border-radius:5px;margin-bottom:18px;flex-shrink:0;`;keyEl.textContent=para.keyExpr;body.appendChild(keyEl);}
  let html=para.rest;
  (para.links||[]).forEach(lw=>{const esc=lw.replace(/[.*+?^${}()|[\]\\]/g,'\\$&');html=html.replace(new RegExp(esc),'<span style="color:var(--red);font-weight:700;font-family:\'DM Mono\',monospace;font-size:clamp(13px,1.6vw,16px);">'+lw+'</span>');});
  const paraEl=document.createElement('div');
  paraEl.style.cssText='font-family:"Instrument Sans",sans-serif;font-size:clamp(16px,2.2vw,22px);font-weight:400;line-height:1.6;color:var(--ink);flex-shrink:0;opacity:0;transform:translateY(8px);transition:opacity .45s ease,transform .5s cubic-bezier(.22,1,.36,1);';
  paraEl.innerHTML=html; body.appendChild(paraEl);
  const spacer=document.createElement('div'); spacer.style.cssText='flex:1;min-height:6px;'; body.appendChild(spacer);
  if (para.note){const noteEl=document.createElement('div');noteEl.style.cssText='font-family:"DM Mono",monospace;font-size:clamp(11px,1.4vw,14px);line-height:1.6;color:rgba(28,28,30,.5);background:rgba(0,0,0,.04);border-left:3px solid rgba(0,0,0,.14);padding:10px 16px;border-radius:0 6px 6px 0;flex-shrink:0;opacity:0;transition:opacity .5s .6s ease;';noteEl.textContent='💡 '+para.note;body.appendChild(noteEl);setTimeout(()=>{noteEl.style.opacity='1';},700);}
  await wait(60,myGen); if (!running||!bodyOvOn||myGen!==gen) return;
  paraEl.offsetHeight; paraEl.style.opacity='1'; paraEl.style.transform='none';
  await wait(180,myGen); if (!running||!bodyOvOn||myGen!==gen) return;
  waveOn();
  const fullText=para.starter+(para.opinion?' '+para.opinion+',':'')+(para.keyExpr?' '+para.keyExpr:'')+para.rest;
  // para.audioN = 1-based local file number for this body paragraph
  await Promise.all([
    speak(fullText, myGen, para.audioN),
    wait(4000, myGen)
  ]);
  if (!running||!bodyOvOn||myGen!==gen){waveOff();return;}
  waveOff(); await wait(800,myGen);
}

// ══ CONCLUSION ══
async function speakThenShow(stkId,text,isFirst,role,kw,myGen,n) {
  if (!running||myGen!==gen) return;
  const stk=document.getElementById(stkId); if (!stk) return;
  const line=document.createElement('div'); line.className='s-line'+(isFirst?' first':'');
  let html=text; if(kw) html=text.replace(kw,`<span style="color:var(--red);font-weight:700">${kw}</span>`);
  if (role) line.innerHTML=`<span class="s-role" style="color:var(--red);background:rgba(201,20,15,.07)">${role}</span>${html}`;
  else line.innerHTML=html;
  stk.appendChild(line); await wait(20,myGen); line.classList.add('in');
  line.scrollIntoView({behavior:'smooth',block:'nearest'});
  await wait(220,myGen); if (!running||myGen!==gen) return;
  await speak(text, myGen, n); if (!running||myGen!==gen) return;
  await wait(180,myGen);
}

// ══ SC2 BUILD ══
function sc2ShowIdle() {
  document.getElementById('sc2Idle').style.display='flex';
  document.getElementById('sc2Build').style.display='none';
}
function sc2ResetBuild() {
  document.getElementById('sc2Idle').style.display='none';
  const build=document.getElementById('sc2Build');
  build.style.opacity='1'; build.style.transition='';
  build.innerHTML=
    '<div id="sc2Kicker" style="font-family:\'DM Mono\',monospace;font-size:9px;letter-spacing:3px;text-transform:uppercase;color:var(--ink3);margin-bottom:6px;opacity:0;transition:opacity .4s;flex-shrink:0;">Each body paragraph has two parts</div>'+
    '<div id="sc2ClaimBlock" style="flex-shrink:0;opacity:0;transform:translateY(14px);transition:opacity .35s,transform .4s cubic-bezier(.22,1,.36,1);"><div style="font-family:\'Barlow Condensed\',sans-serif;font-size:clamp(32px,7vw,48px);font-weight:900;line-height:.86;letter-spacing:1px;color:var(--ink);">CLAIM</div></div>'+
    '<div id="sc2ClaimItems" style="flex-shrink:0;display:flex;flex-direction:column;gap:4px;margin-top:6px;margin-bottom:6px;padding-left:4px;border-left:3px solid var(--red);"></div>'+
    '<div id="sc2Sep" style="flex-shrink:0;opacity:0;transition:opacity .3s;margin:2px 0 4px;"><div style="font-family:\'Barlow Condensed\',sans-serif;font-size:clamp(16px,3vw,22px);font-weight:900;color:var(--red);line-height:1;">+</div></div>'+
    '<div id="sc2SupportBlock" style="flex-shrink:0;opacity:0;transform:translateY(14px);transition:opacity .35s,transform .4s cubic-bezier(.22,1,.36,1);"><div style="font-family:\'Barlow Condensed\',sans-serif;font-size:clamp(32px,7vw,48px);font-weight:900;line-height:.86;letter-spacing:1px;color:var(--ink);">SUPPORT</div></div>'+
    '<div id="sc2SupportItems" style="flex-shrink:0;display:flex;flex-direction:column;gap:4px;margin-top:6px;padding-left:4px;border-left:3px solid rgba(28,28,30,.18);"></div>';
  build.style.display='flex';
}
async function sc2AddItem(containerId,text,color,myGen,modalKey) {
  if (!running||myGen!==gen) return;
  const c=document.getElementById(containerId); if (!c) return;
  const item=document.createElement('div'); item.className='sc2-chip';
  item.style.cssText=`color:${color};cursor:${modalKey?'pointer':'default'};`;
  item.innerHTML=`<span style="width:5px;height:5px;border-radius:50%;background:${color};flex-shrink:0;display:inline-block;opacity:.7;"></span>${text.label}`;
  if (modalKey) item.onclick=()=>openSecModal(modalKey);
  c.appendChild(item); await wait(30,myGen); item.classList.add('in'); await wait(200,myGen);
}
function sc2PopulateFullList() {
  const build=document.getElementById('sc2Build'); if (!build) return;
  build.style.transition='opacity .3s'; build.style.opacity='0';
  const CLAIM=[
    {color:'#c9140f',label:'LISTING MARKER',phrases:['Firstly,','Furthermore,','In addition,','However,','On the other hand,']},
    {color:'#1a5c8a',label:'PERSONAL VIEW',phrases:['in my opinion,','it seems to me that','as far as I am concerned,']},
    {color:'#1a6b3c',label:'THE CLAIM',phrases:['the main advantage of …','one key problem with …','an important point is …']}
  ];
  const SUPPORT=[
    {color:'#1a6b3c',label:'REASON',phrases:['This is because …','The reason is that …','Since …']},
    {color:'#1a5c8a',label:'EXAMPLE',phrases:['For example,','For instance,','This can be seen in …']},
    {color:'#e07b00',label:'CONTRAST',phrases:['Although …','However,','Even though …']},
    {color:'#6b4ea8',label:'RESULT',phrases:['As a result,','Consequently,','Therefore,']}
  ];
  function renderCol(groups){return groups.map(g=>`<div style="margin-bottom:12px;"><div style="font-family:'DM Mono',monospace;font-size:8px;font-weight:700;letter-spacing:1.8px;text-transform:uppercase;color:${g.color};margin-bottom:5px;padding-left:8px;border-left:3px solid ${g.color};">${g.label}</div>${g.phrases.map(p=>`<div style="font-family:'Instrument Sans',sans-serif;font-size:clamp(11px,1.5vw,13px);color:rgba(28,28,30,.62);line-height:1.7;padding-left:11px;">${p}</div>`).join('')}</div>`).join('');}
  setTimeout(()=>{
    build.innerHTML=`<div style="padding:46px 0 0;flex:1;min-height:0;display:flex;flex-direction:column;overflow:hidden;"><div style="flex:1;min-height:0;display:flex;overflow:hidden;"><div style="flex:1;min-width:0;display:flex;flex-direction:column;overflow-y:auto;scrollbar-width:none;padding:8px 14px 12px 18px;border-right:1px solid rgba(0,0,0,.07);"><div style="font-family:'Barlow Condensed',sans-serif;font-size:clamp(22px,5vw,32px);font-weight:900;letter-spacing:1px;color:var(--ink);line-height:.9;margin-bottom:12px;">CLAIM</div>${renderCol(CLAIM)}</div><div style="flex:1;min-width:0;display:flex;flex-direction:column;overflow-y:auto;scrollbar-width:none;padding:8px 14px 12px 14px;"><div style="font-family:'Barlow Condensed',sans-serif;font-size:clamp(22px,5vw,32px);font-weight:900;letter-spacing:1px;color:var(--ink);line-height:.9;margin-bottom:12px;">SUPPORT</div>${renderCol(SUPPORT)}</div></div><div style="flex-shrink:0;display:flex;justify-content:center;padding:10px 0 4px;"><button onclick="showPhraseBank()" style="font-family:'DM Mono',monospace;font-size:9px;font-weight:600;letter-spacing:1.5px;text-transform:uppercase;padding:7px 16px;border-radius:20px;border:1.5px solid rgba(28,28,30,.18);background:transparent;color:var(--ink3);cursor:pointer;">Explore all phrases →</button></div></div>`;
    build.style.transition='opacity .5s'; build.style.opacity='1';
  },320);
}

// ══ SECONDARY MODAL ══
const MODAL_DATA = {
  listing:{label:'Listing Marker',section:'CLAIM',color:'#c9140f',glow:'rgba(201,20,15,.22)',title:'Listing Markers',phrases:[{text:'Firstly,',note:'introduces your first point'},{text:'Furthermore,',note:'adds a second point'},{text:'In addition,',note:'adds another point'},{text:'However,',note:'introduces a contrast'},{text:'On the other hand,',note:'introduces opposing view'}]},
  view:{label:'Personal View',section:'CLAIM',color:'#1a5c8a',glow:'rgba(26,92,138,.22)',title:'Expressing a View',phrases:[{text:'in my opinion,',note:'most common — always safe'},{text:'it seems to me that',note:'softer, more academic tone'},{text:'as far as I am concerned,',note:'strong, formal register'},{text:'I firmly believe that',note:'emphatic — for strong opinions'},{text:'It is widely believed that',note:'distanced — good for balance'}]},
  claim:{label:'The Claim',section:'CLAIM',color:'#1a6b3c',glow:'rgba(26,107,60,.22)',title:'Making a Claim',phrases:[{text:'the main advantage of … is',note:'best for positive points'},{text:'one key problem with … is',note:'best for negative points'},{text:'the most important point is',note:'signals your strongest argument'},{text:'one clear benefit of … is',note:'variation of advantage'},{text:'an important issue is',note:'neutral — works for any claim'}]},
  reason:{label:'Reason',section:'SUPPORT',color:'#1a6b3c',glow:'rgba(26,107,60,.22)',title:'Giving a Reason',phrases:[{text:'This is because…',note:'most natural — always works'},{text:'The reason is that…',note:'more formal alternative'},{text:'This is largely due to…',note:'academic register'},{text:'Since…',note:'use at start of sentence'},{text:'The explanation for this is…',note:'high register — for top marks'}]},
  example:{label:'Example',section:'SUPPORT',color:'#1a5c8a',glow:'rgba(26,92,138,.22)',title:'Giving an Example',phrases:[{text:'For example,',note:'simplest — use this first'},{text:'For instance,',note:'equivalent to "for example"'},{text:'Indeed,',note:'stronger — confirms or emphasises'},{text:'This can be seen in…',note:'links to real-world evidence'},{text:'A good illustration of this is…',note:'sophisticated — names example clearly'}]},
  result:{label:'Result',section:'SUPPORT',color:'#6b4ea8',glow:'rgba(107,78,168,.22)',title:'Showing a Result',phrases:[{text:'As a result,',note:'most common — always safe'},{text:'Consequently,',note:'more formal'},{text:'Therefore,',note:'logical conclusion — strong signal'},{text:'This means that…',note:'explains implication directly'},{text:'This leads to…',note:'shows cause and effect clearly'}]},
  more:{label:'And More…',section:'SUPPORT',color:'#e07b00',glow:'rgba(224,123,0,.22)',title:'Contrast & Rephrase',phrases:[{text:'Although…',note:'contrast — acknowledge counter-argument'},{text:'Even though…',note:'stronger contrast'},{text:'However,',note:'pivot — changes direction'},{text:'In other words,',note:'rephrases your point'},{text:'Unlike…',note:'direct comparison'}]}
};
function swapModalContent(key,durationMs) {
  const d=MODAL_DATA[key]; if(!d) return;
  document.getElementById('smCard').style.boxShadow=`4px 6px 0 rgba(0,0,0,.5),0 0 0 1px rgba(255,255,255,.06),0 24px 55px rgba(0,0,0,.55),0 0 60px ${d.glow}`;
  document.getElementById('smFlagBody').style.background=d.color;
  document.getElementById('smFlagTxt').textContent=d.label;
  document.getElementById('smSectionLbl').textContent=d.section;
  document.getElementById('smTitle').textContent=d.title;
  document.getElementById('smAccentBar').style.background=d.color;
  const pc=document.getElementById('smPhrases'); pc.innerHTML='';
  d.phrases.forEach((p,i)=>{const row=document.createElement('div');row.className='sm-phrase';row.innerHTML=`<div class="sm-phrase-bullet" style="background:${d.color};margin-top:8px;"></div><div><div class="sm-phrase-text">${p.text}</div><div class="sm-phrase-note">${p.note}</div></div>`;pc.appendChild(row);setTimeout(()=>row.classList.add('in'),i*60+80);});
  const bar=document.getElementById('smTimerBar');
  if(bar){bar.style.background=d.color;bar.style.transition='none';bar.style.width='100%';if(durationMs){requestAnimationFrame(()=>{requestAnimationFrame(()=>{bar.style.transition=`width ${durationMs}ms linear`;bar.style.width='0%';});});}}
}
function openSecModal(key,durationMs){swapModalContent(key,durationMs);document.getElementById('smBackdrop').classList.add('open');document.getElementById('smWrap').classList.add('open');}
function closeSecModal(){const bd=document.getElementById('smBackdrop');const wr=document.getElementById('smWrap');if(bd){bd.classList.remove('open');bd.classList.remove('dim');}if(wr)wr.classList.remove('open');}

// ══ BODY INTRO LECTURE ══
async function runBodyIntro(myGen) {
  if (!running||myGen!==gen) return;
  sc2ResetBuild();
  const kicker=document.getElementById('sc2Kicker');
  const claimBlock=document.getElementById('sc2ClaimBlock');
  if(kicker) kicker.style.opacity='1';
  await wait(40,myGen); if(!running||myGen!==gen) return;
  if(claimBlock){claimBlock.style.opacity='1';claimBlock.style.transform='none';}
  await wait(200,myGen); if(!running||myGen!==gen) return;
  waveOn();

  // SK.sc2Lecture contains narration steps with optional n= file numbers
  for (const step of (SK.sc2Lecture||[])) {
    await speak(step.text, myGen, step.n);
    if (!running||myGen!==gen){waveOff();return;}
    if (step.chip) {
      const container = step.chip.side==='claim' ? 'sc2ClaimItems' : 'sc2SupportItems';
      await sc2AddItem(container, {label:step.chip.label}, step.chip.color, myGen, step.chip.modal||null);
      if (!running||myGen!==gen){waveOff();return;}
    }
    if (step.showSep) {
      const sep=document.getElementById('sc2Sep');
      const supportBlock=document.getElementById('sc2SupportBlock');
      if(sep) sep.style.opacity='1';
      await wait(60,myGen); if(!running||myGen!==gen) return;
      if(supportBlock){supportBlock.style.opacity='1';supportBlock.style.transform='none';}
      await wait(150,myGen); if(!running||myGen!==gen) return;
    }
  }

  waveOff();
  await wait(500,myGen); if(!running||myGen!==gen) return;
  sc2PopulateFullList();
  await wait(800,myGen); if(!running||myGen!==gen) return;
  waveOn();
  await speak("Now watch three complete body paragraphs. See how all these pieces fit together.", myGen, SK.sc2TransitionN);
  if(!running||myGen!==gen){waveOff();return;}
  waveOff();
  await wait(400,myGen); if(!running||myGen!==gen) return;
  await runBodyPairs(myGen);
}

// ══ MAIN SCENE RUNNER ══
async function runScene(idx,myGen) {
  if(!running||myGen!==gen) return;
  if(idx>=SCENE_COUNT){finishAll();return;}
  clearStacks(); showScene(idx);

  if(idx===0){
    waveOn();
    await speak(SK.welcomeNarration, myGen, SK.welcomeN);
    if(!running||myGen!==gen){waveOff();return;}
    waveOff();

  } else if(idx===1){
    showInter('INTRODUCTION','var(--c-intro)',SK.interKicker,SK.interBig,SK.interSub,'var(--c-intro)');
    await speak(SK.sc1Narration, myGen, SK.sc1NarrationN);
    if(!running||myGen!==gen) return;
    await wait(400,myGen); if(!running||myGen!==gen) return;
    hideInter(); await wait(260,myGen); if(!running||myGen!==gen) return;
    waveOn();
    await speak(SK.sc1QuestionNarration, myGen, SK.sc1QuestionN);
    if(!running||myGen!==gen){waveOff();return;}
    waveOff(); await wait(240,myGen); if(!running||myGen!==gen) return;
    await runIntroPairs(myGen);

  } else if(idx===2){
    await runBodyIntro(myGen);

  } else if(idx===3){
    const sk=document.getElementById('conclSkeleton'); if(sk) sk.style.display='none';
    const hint=document.getElementById('conclHint'); if(hint) hint.style.display='none';
    const CONCL_DATA=getCONCL_DATA();
    const narrations=SK.conclNarrations||[];
    const narrationNs=SK.conclNarrationNs||[];    // n= values for interstitial narrations
    const sentenceNs=SK.conclSentenceNs||[];       // n= values for the sentence reads
    waveOn();
    for(let i=0;i<CONCL_DATA.length;i++){
      if(!running||myGen!==gen){waveOff();return;}
      if(narrations[i]) {
        await speak(narrations[i], myGen, narrationNs[i]);
        if(!running||myGen!==gen){waveOff();return;}
      }
      await speakThenShow('stk3',CONCL_DATA[i].text,i===0,CONCL_DATA[i].role,CONCL_DATA[i].kw,myGen,sentenceNs[i]);
      if(!running||myGen!==gen){waveOff();return;}
    }
    waveOff();
  }

  if(!running||myGen!==gen) return;
  await wait(400,myGen); if(!running||myGen!==gen) return;
  const sectionEnd=SECTION_END[activeSection]??(SCENE_COUNT-1);
  if(idx>=sectionEnd){finishSection();return;}
  cur=idx+1; runScene(cur,myGen);
}

function handlePlay() {
  initAudioPool();
  if(!running){
    if(cur===0) activeSection='intro';
    running=true; const myGen=gen;
    const b=document.getElementById('btnPlay'); b.textContent='⏹'; b.classList.add('running');
    updateNavBtns(); runScene(cur,myGen);
  } else {hardStop();updateNavBtns();}
}
function clearStacks(){
  const el=document.getElementById('stk3'); if(el) el.innerHTML='';
  const sk=document.getElementById('conclSkeleton'); if(sk) sk.style.display='flex';
  const hint=document.getElementById('conclHint'); if(hint) hint.style.display='block';
  sc2ShowIdle();
}
function nextScene(){hardStop();clearStacks();if(cur+1<SCENE_COUNT)cur++;activeSection=sectionForScene(cur);showScene(cur);updateNavBtns();}
function prevScene(){if(cur===0)return;hardStop();clearStacks();cur=Math.max(0,cur-1);activeSection=sectionForScene(cur);showScene(cur);updateNavBtns();}
function updateNavBtns(){document.getElementById('btnPrev').disabled=cur<=0;document.getElementById('btnNext').disabled=cur>=SCENE_COUNT-1;}
function finishSection(){hardStop();const b=document.getElementById('btnPlay');if(b){b.textContent='▶';b.classList.remove('running');}updateNavBtns();}
function finishAll(){finishSection();}

let activeNtab='descriptors';
function renderNotes(tab){const body=document.getElementById('notesBody');const secs=NOTES_DATA[tab]||[];let h='';secs.forEach(s=>{h+=`<div class="n-section"><div class="n-stitle">${s.title}</div>`;s.items.forEach(it=>{h+=`<div class="n-item">${it}</div>`;});h+='</div>';});body.innerHTML=h;}
function switchNtab(t){activeNtab=t;document.querySelectorAll('.ntab').forEach(b=>b.classList.toggle('on',b.dataset.ntab===t));renderNotes(t);}
function openNotes(){renderNotes(activeNtab);document.getElementById('notesPanel').classList.add('show');}
function closeNotes(){document.getElementById('notesPanel').classList.remove('show');syncTab(cur);}
function flashColor(){const f=document.getElementById('flash');f.classList.add('pop');setTimeout(()=>f.classList.remove('pop'),20);}
const EMJS=[['📖'],['📱'],['📐'],['✅']];
function spawnEmoji(idx){const list=EMJS[idx]||[];const r=document.getElementById('stage').getBoundingClientRect();list.forEach((em,i)=>{setTimeout(()=>{const el=document.createElement('div');el.className='fem';el.textContent=em;el.style.cssText=`left:${r.left+r.width*.2+Math.random()*r.width*.6}px;top:${r.top+r.height*.45+Math.random()*r.height*.35}px;animation-duration:${1.9+Math.random()*.7}s;`;document.body.appendChild(el);setTimeout(()=>el.remove(),2500);},i*160);});}

document.addEventListener('keydown',e=>{if(e.key===' '){e.preventDefault();handlePlay();}if(e.key==='ArrowRight')nextScene();if(e.key==='ArrowLeft')prevScene();if(e.key==='Escape'){hardStop();updateNavBtns();closeNotes();}});
let _tx=0,_ty=0;
document.addEventListener('touchstart',e=>{_tx=e.changedTouches[0].screenX;_ty=e.changedTouches[0].screenY;},{passive:true});
document.addEventListener('touchend',e=>{
  if(bodyOvOn||introOvOn||pbOvOn)return;
  if(document.getElementById('notesPanel').classList.contains('show'))return;
  if(document.getElementById('interOv').classList.contains('show'))return;
  const dx=e.changedTouches[0].screenX-_tx;
  const dy=e.changedTouches[0].screenY-_ty;
  if(Math.abs(dy)>Math.abs(dx))return;
  if(dx<-80)nextScene();
  if(dx>80)prevScene();
});

window.addEventListener('resize',updateFooterVar);
buildDots(); updateDots(0); showScene(0); updateNavBtns();
requestAnimationFrame(updateFooterVar);
</script>
</body>
</html>
