<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
<title>ESSAY BUILDER</title>
<link href="https://fonts.googleapis.com/css2?family=Barlow+Condensed:wght@700;800;900&family=Instrument+Sans:ital,wght@0,400;0,500;0,600;0,700;1,400&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet"/>
<style>
:root{
  --bg:#FAF9F7;--ink:#1C1C1E;--ink2:rgba(28,28,30,0.92);--ink3:rgba(28,28,30,0.75);
  --red:#c9140f;--red-s:rgba(201,20,15,0.08);--border:rgba(28,28,30,0.08);
  --c-intro:#3d9e95;--c-b1:#c9140f;--c-b3:#7b5ea7;--c-conc:#2d7a3a;
  --footer-h:148px;
}
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
html{font-size:16px;}
html,body{width:100%;height:100%;overflow:hidden;position:fixed;background:var(--bg);
  font-family:'Instrument Sans',sans-serif;color:var(--ink);-webkit-font-smoothing:antialiased;}
.shell{position:fixed;inset:0;display:flex;flex-direction:column;}
.topbar{flex-shrink:0;display:flex;align-items:center;gap:10px;padding:10px 18px 9px;
  background:rgba(250,249,247,0.97);border-bottom:1px solid var(--border);backdrop-filter:blur(14px);z-index:100;}
.logo{font-family:'Barlow Condensed',sans-serif;font-size:18px;font-weight:900;letter-spacing:4px;text-transform:uppercase;}
.logo span{color:var(--red);}
.spacer{flex:1;}
.tbctr{font-family:'DM Mono',monospace;font-size:11px;letter-spacing:1.5px;color:var(--ink3);}
.stage{flex:1;min-height:0;position:relative;overflow:hidden;display:flex;align-items:center;justify-content:center;background:var(--bg);}
.poster{position:relative;width:min(460px,93vw);height:min(530px,76vh);background:#fff;border-radius:22px;
  border:1px solid rgba(28,28,30,0.10);display:flex;flex-direction:column;overflow:hidden;flex-shrink:0;
  box-shadow:4px 6px 0 rgba(0,0,0,.07),0 24px 55px rgba(0,0,0,.13),0 4px 14px rgba(0,0,0,.07);
  animation:pIn .42s cubic-bezier(.22,1,.36,1) both;}
.poster::before{content:'';position:absolute;bottom:-8px;left:6px;right:6px;height:100%;background:#fff;border:1px solid rgba(0,0,0,.07);border-radius:22px;z-index:-1;}
.poster::after{content:'';position:absolute;bottom:-15px;left:13px;right:13px;height:100%;background:#fff;border:1px solid rgba(0,0,0,.05);border-radius:22px;z-index:-2;}
@keyframes pIn{from{opacity:0;transform:translateY(18px) scale(.96);}to{opacity:1;transform:none;}}
.flag{position:absolute;top:-2px;left:22px;z-index:10;}
.flag-body{min-width:80px;padding:11px 14px 10px;display:flex;align-items:center;justify-content:center;position:relative;}
.flag-num{font-family:'Barlow Condensed',sans-serif;font-size:15px;font-weight:900;letter-spacing:2px;text-transform:uppercase;color:#fff;white-space:nowrap;}
.flag-body::after{content:'';position:absolute;bottom:-8px;left:0;right:0;height:9px;background:inherit;
  clip-path:polygon(0% 0%,8.33% 100%,16.66% 0%,25% 100%,33.33% 0%,41.66% 100%,50% 0%,58.33% 100%,66.66% 0%,75% 100%,83.33% 0%,91.66% 100%,100% 0%);}
.section-lbl{position:absolute;top:16px;right:20px;font-family:'Barlow Condensed',sans-serif;font-size:11px;font-weight:900;letter-spacing:3px;text-transform:uppercase;opacity:.3;}
.card-dots-row{flex-shrink:0;display:flex;align-items:center;justify-content:space-between;padding:7px 16px 6px;border-top:1px solid rgba(0,0,0,.06);}
.card-arrow{width:30px;height:30px;border-radius:50%;background:transparent;border:none;font-size:18px;font-weight:700;color:var(--ink3);cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .18s;}
.card-arrow:hover:not([disabled]){color:var(--ink);background:rgba(0,0,0,.07);}
.card-arrow[disabled]{opacity:.15;cursor:not-allowed;}
.dots{display:flex;gap:5px;align-items:center;}
.dot{width:6px;height:6px;border-radius:50%;background:rgba(0,0,0,.16);transition:all .3s cubic-bezier(.22,1,.36,1);}
.dot.active{width:18px;border-radius:3px;background:var(--ink);}
.dot.done{background:rgba(0,0,0,.34);}
.accent-bar{height:5px;flex-shrink:0;}
.footer{flex-shrink:0;background:rgba(250,249,247,0.99);border-top:1px solid var(--border);backdrop-filter:blur(16px);z-index:999;padding-bottom:calc(env(safe-area-inset-bottom,0px) + 6px);}
.playback-row{display:flex;align-items:center;justify-content:center;gap:20px;padding:12px 18px 8px;}
.btn-nav{width:48px;height:48px;border-radius:50%;background:rgba(0,0,0,.07);border:1px solid var(--border);font-size:22px;color:var(--ink3);cursor:pointer;transition:all .18s;display:flex;align-items:center;justify-content:center;flex-shrink:0;}
.btn-nav:hover:not([disabled]){color:var(--ink);background:rgba(0,0,0,.12);}
.btn-nav:active:not([disabled]){transform:scale(.92);}
.btn-nav[disabled]{opacity:.15;cursor:not-allowed;}
.btn-play{width:64px;height:64px;border-radius:50%;border:none;background:var(--ink);color:#fff;cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0;box-shadow:0 4px 0 rgba(0,0,0,.28),0 8px 22px rgba(0,0,0,.22);transition:all .18s;font-size:22px;}
.btn-play:active{transform:translateY(2px);box-shadow:0 2px 0 rgba(0,0,0,.28);}
.btn-play.running{background:var(--red);box-shadow:0 4px 0 rgba(100,6,6,.4),0 8px 22px rgba(201,20,15,.24);}
.wave{display:flex;align-items:flex-end;gap:3px;height:22px;width:32px;}
.wb{width:4px;border-radius:2px;background:var(--ink3);}
.wb:nth-child(1){height:28%}.wb:nth-child(2){height:62%}.wb:nth-child(3){height:100%}.wb:nth-child(4){height:72%}.wb:nth-child(5){height:40%}
.wave.on .wb{animation:wv .9s ease-in-out infinite;}
.wb:nth-child(1){animation-delay:.00s}.wb:nth-child(2){animation-delay:.08s}.wb:nth-child(3){animation-delay:.16s}.wb:nth-child(4){animation-delay:.11s}.wb:nth-child(5){animation-delay:.04s}
@keyframes wv{0%,100%{transform:scaleY(.22);opacity:.2}50%{transform:scaleY(1);opacity:.65}}
.wave.off .wb{animation:none;transform:scaleY(.22);opacity:.18;}
.tab-bar-wrap{display:flex;align-items:center;justify-content:center;padding:2px 18px 10px;}
.tab-bar{display:inline-flex;align-items:center;background:rgba(0,0,0,.08);border-radius:30px;padding:4px;gap:2px;}
.tab-btn{font-family:'DM Mono',monospace;font-size:11px;letter-spacing:1.2px;text-transform:uppercase;padding:8px 16px;border-radius:24px;border:none;cursor:pointer;background:transparent;color:var(--ink3);transition:all .22s cubic-bezier(.22,1,.36,1);white-space:nowrap;font-weight:500;}
.tab-btn.active{background:var(--ink);color:#fff;box-shadow:0 2px 8px rgba(0,0,0,.22);}
.tab-btn:not(.active):hover{color:var(--ink2);}
.scene{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:10px;pointer-events:none;opacity:0;}
.scene.active{opacity:1;pointer-events:all;}
.sentence-scroll{flex:1;min-height:0;overflow-y:auto;display:flex;flex-direction:column;gap:6px;scrollbar-width:none;}
.sentence-scroll::-webkit-scrollbar{display:none;}
.s-line{font-family:'Instrument Sans',sans-serif;font-size:15px;font-weight:400;line-height:1.6;color:rgba(17,17,17,.80);flex-shrink:0;opacity:0;transform:translateY(7px);transition:opacity .36s ease,transform .42s cubic-bezier(.22,1,.36,1);padding:5px 0;border-bottom:1px solid rgba(0,0,0,.05);}
.s-line:last-child{border-bottom:none;}
.s-line.in{opacity:1;transform:none;}
.s-line.first{color:var(--ink);font-weight:600;font-size:16px;}
.s-role{display:inline-block;font-family:'DM Mono',monospace;font-size:9px;font-weight:500;letter-spacing:1.5px;text-transform:uppercase;padding:2px 7px;border-radius:2px;margin-right:8px;vertical-align:middle;border-left:2.5px solid currentColor;}

/* INTERSTITIAL ‚Äî sits above stage, below footer */
.inter-ov{position:fixed;inset:0 0 var(--footer-h) 0;z-index:200;background:#FAF9F7;display:flex;align-items:center;justify-content:center;pointer-events:none;opacity:0;transition:opacity .3s;}
.inter-ov.show{opacity:1;}
.inter-card{width:min(460px,92vw);height:min(530px,calc(100vh - var(--footer-h) - 28px));background:#fff;border-radius:22px;box-shadow:4px 6px 0 rgba(0,0,0,.06),0 24px 55px rgba(0,0,0,.16);overflow:hidden;display:flex;flex-direction:column;flex-shrink:0;position:relative;opacity:0;transform:translateY(20px) scale(.97);transition:opacity .38s .06s,transform .44s .06s cubic-bezier(.22,1,.36,1);}
.inter-ov.show .inter-card{opacity:1;transform:none;}
.inter-flag{position:absolute;top:-2px;left:22px;z-index:10;}
.inter-flag-body{padding:10px 14px 9px;display:flex;align-items:center;justify-content:center;position:relative;}
.inter-flag-body::after{content:'';position:absolute;bottom:-8px;left:0;right:0;height:9px;background:inherit;clip-path:polygon(0% 0%,8.33% 100%,16.66% 0%,25% 100%,33.33% 0%,41.66% 100%,50% 0%,58.33% 100%,66.66% 0%,75% 100%,83.33% 0%,91.66% 100%,100% 0%);}
.inter-flag-num{font-family:'Barlow Condensed',sans-serif;font-size:15px;font-weight:900;color:#fff;letter-spacing:2px;text-transform:uppercase;white-space:nowrap;}
.inter-body{flex:1;min-height:0;padding:58px 28px 20px;display:flex;flex-direction:column;justify-content:center;gap:14px;}
.inter-kicker{font-family:'DM Mono',monospace;font-size:10px;letter-spacing:3px;text-transform:uppercase;color:var(--ink3);}
.inter-big{font-family:'Barlow Condensed',sans-serif;font-size:clamp(38px,7vw,58px);font-weight:900;line-height:.9;letter-spacing:1px;color:var(--ink);}
.inter-big em{font-style:normal;color:var(--inter-accent,var(--red));}
.inter-sub{font-family:'Instrument Sans',sans-serif;font-size:16px;font-weight:400;line-height:1.55;color:var(--ink2);}
.inter-sub strong{color:var(--ink);font-weight:600;}
.inter-bottom{height:5px;flex-shrink:0;}

/* INTRO PAIRS ‚Äî FIX: bottom stops at footer */
.ov{position:fixed;inset:0 0 var(--footer-h) 0;z-index:200;background:#FAF9F7;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:14px;pointer-events:none;opacity:0;transition:opacity .26s;}
.ov.show{opacity:1;pointer-events:all;}
.ob{width:min(460px,92vw);height:min(530px,calc(100vh - var(--footer-h) - 28px));background:#fff;border-radius:22px;box-shadow:4px 6px 0 rgba(0,0,0,.06),0 24px 55px rgba(0,0,0,.16);overflow:hidden;display:flex;flex-direction:column;opacity:0;transform:translateY(24px) scale(.95);transition:opacity .36s,transform .44s cubic-bezier(.22,1,.36,1);position:relative;flex-shrink:0;}
.ov.show .ob{opacity:1;transform:none;}
.ob.exit{opacity:0!important;transform:translateX(-44px) scale(.93)!important;transition:opacity .17s,transform .2s ease!important;}
.ob-flag{position:absolute;top:-2px;left:22px;z-index:10;}
.ob-flag-body{padding:9px 14px 8px;background:var(--c-intro);display:flex;align-items:center;justify-content:center;position:relative;}
.ob-flag-body::after{content:'';position:absolute;bottom:-8px;left:0;right:0;height:9px;background:var(--c-intro);clip-path:polygon(0% 0%,8.33% 100%,16.66% 0%,25% 100%,33.33% 0%,41.66% 100%,50% 0%,58.33% 100%,66.66% 0%,75% 100%,83.33% 0%,91.66% 100%,100% 0%);}
.ob-flag-num{font-family:'Barlow Condensed',sans-serif;font-size:15px;font-weight:900;color:#fff;white-space:nowrap;letter-spacing:2px;text-transform:uppercase;}
.ob-pair-lbl{position:absolute;top:16px;right:20px;font-family:'DM Mono',monospace;font-size:10px;letter-spacing:2px;text-transform:uppercase;color:var(--ink3);}
.ob-body{flex:1;min-height:0;padding:52px 28px 14px;display:flex;flex-direction:column;justify-content:center;overflow:hidden;}
.ob-hlbl{font-family:'DM Mono',monospace;font-size:10px;letter-spacing:2.5px;text-transform:uppercase;color:var(--c-intro);margin-bottom:8px;flex-shrink:0;}
.ob-starter{font-family:'Barlow Condensed',sans-serif;font-size:clamp(32px,6.5vw,48px);font-weight:900;line-height:.9;letter-spacing:1px;color:var(--ink);flex-shrink:0;}
.ob-link{font-family:'Instrument Sans',sans-serif;font-weight:400;font-size:15px;line-height:1.52;color:var(--ink2);margin-top:10px;flex-shrink:0;opacity:0;transform:translateY(4px);transition:opacity .34s .3s,transform .4s .3s cubic-bezier(.22,1,.36,1);}
.ov.show .ob:not(.exit) .ob-link{opacity:1;transform:none;}
.ob-rest{font-family:'Instrument Sans',sans-serif;font-weight:400;font-size:15px;line-height:1.52;color:var(--ink2);margin-top:10px;flex-shrink:0;opacity:0;transform:translateY(6px);transition:opacity .34s .46s,transform .4s .46s cubic-bezier(.22,1,.36,1);}
.ov.show .ob:not(.exit) .ob-rest{opacity:1;transform:none;}
.ob-sep{margin:14px 0;display:flex;align-items:center;gap:10px;flex-shrink:0;}
.ob-sep::before{content:'';flex:1;height:1px;background:rgba(0,0,0,.08);}
.ob-sep::after{content:'‚Üì';font-family:'Barlow Condensed',sans-serif;font-size:16px;font-weight:900;color:var(--c-intro);flex-shrink:0;line-height:1;}
.ob-tlbl{font-family:'DM Mono',monospace;font-size:10px;letter-spacing:2.5px;text-transform:uppercase;color:var(--c-intro);margin-bottom:8px;flex-shrink:0;opacity:0;transform:translateY(4px);transition:opacity .28s .5s,transform .32s .5s;}
.ov.show .ob:not(.exit) .ob-tlbl{opacity:1;transform:none;}
.ob-tt{font-family:'Instrument Sans',sans-serif;font-weight:500;font-size:15px;line-height:1.52;color:var(--ink2);opacity:0;transform:translateY(8px);transition:opacity .36s .58s,transform .42s .58s cubic-bezier(.22,1,.36,1);}
.ob-tt strong{color:var(--c-intro);font-weight:700;}
.ov.show .ob:not(.exit) .ob-tt{opacity:1;transform:none;}
.ob-foot{display:flex;align-items:center;justify-content:center;padding:10px 26px 14px;flex-shrink:0;}
.ob-fl{display:none;}
.ob-stop{font-family:'Barlow Condensed',sans-serif;font-size:18px;font-weight:900;letter-spacing:3px;text-transform:uppercase;padding:12px 36px;border-radius:50px;border:none;background:var(--ink);color:#fff;cursor:pointer;transition:all .18s;box-shadow:0 4px 0 rgba(0,0,0,.25),0 6px 18px rgba(0,0,0,.18);}
.ob-stop:hover{background:var(--red);}
.ob-stop:active{transform:translateY(2px);}
.ob-bottom{height:5px;background:var(--c-intro);flex-shrink:0;}
.ob-dots{display:flex;gap:7px;margin-top:10px;}
.bdot{width:7px;height:7px;border-radius:50%;background:rgba(0,0,0,.14);transition:all .3s cubic-bezier(.22,1,.36,1);}
.bdot.active{transform:scale(1.8);background:var(--ink);}
.bdot.done{background:rgba(0,0,0,.3);}

/* BODY PARAGRAPH PAIRS ‚Äî FIX: bottom stops at footer */
.bov{position:fixed;inset:0 0 var(--footer-h) 0;z-index:200;background:#FAF9F7;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:14px;pointer-events:none;opacity:0;transition:opacity .26s;}
.bov.show{opacity:1;pointer-events:all;}
.bob{width:min(460px,92vw);height:min(530px,calc(100vh - var(--footer-h) - 28px));background:#fff;border-radius:22px;box-shadow:4px 6px 0 rgba(0,0,0,.06),0 24px 55px rgba(0,0,0,.16);overflow:hidden;display:flex;flex-direction:column;opacity:0;transform:translateY(24px) scale(.95);transition:opacity .36s,transform .44s cubic-bezier(.22,1,.36,1);position:relative;flex-shrink:0;}
.bov.show .bob{opacity:1;transform:none;}
.bob.exit{opacity:0!important;transform:translateX(-44px) scale(.93)!important;transition:opacity .17s,transform .2s ease!important;}
.bob-flag{position:absolute;top:-2px;left:22px;z-index:10;}
.bob-flag-body{padding:9px 14px 8px;display:flex;align-items:center;justify-content:center;position:relative;}
.bob-flag-body::after{content:'';position:absolute;bottom:-8px;left:0;right:0;height:9px;background:inherit;clip-path:polygon(0% 0%,8.33% 100%,16.66% 0%,25% 100%,33.33% 0%,41.66% 100%,50% 0%,58.33% 100%,66.66% 0%,75% 100%,83.33% 0%,91.66% 100%,100% 0%);}
.bob-flag-num{font-family:'Barlow Condensed',sans-serif;font-size:14px;font-weight:900;color:#fff;white-space:nowrap;letter-spacing:2px;text-transform:uppercase;}
.bob-pair-lbl{position:absolute;top:16px;right:20px;font-family:'DM Mono',monospace;font-size:10px;letter-spacing:2px;text-transform:uppercase;color:var(--ink3);}
.bob-body{flex:1;min-height:0;padding:50px 24px 8px 26px;display:flex;flex-direction:column;overflow-y:auto;scrollbar-width:none;}
.bob-body::-webkit-scrollbar{display:none;}
.bob-foot{display:flex;align-items:center;justify-content:center;padding:10px 24px 14px;flex-shrink:0;border-top:1px solid rgba(0,0,0,.06);}
.bob-fl{display:none;}
.bob-stop{font-family:'Barlow Condensed',sans-serif;font-size:18px;font-weight:900;letter-spacing:3px;text-transform:uppercase;padding:12px 36px;border-radius:50px;border:none;background:var(--ink);color:#fff;cursor:pointer;transition:all .18s;box-shadow:0 4px 0 rgba(0,0,0,.25),0 6px 18px rgba(0,0,0,.18);}
.bob-stop:hover{background:var(--red);}
.bob-stop:active{transform:translateY(2px);}
.bob-wb{width:3px;border-radius:2px;}
.bob-bottom{height:5px;flex-shrink:0;}
.bob-dots{display:flex;gap:7px;margin-top:10px;}

/* NOTES */
.notes-panel{position:fixed;inset:0;z-index:500;background:#FAF9F7;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:14px;pointer-events:none;opacity:0;transition:opacity .26s;}
.notes-panel.show{opacity:1;pointer-events:all;}
.notes-card{width:min(460px,96vw);height:min(600px,88vh);background:#fff;border-radius:22px;border:1px solid rgba(0,0,0,.06);box-shadow:4px 6px 0 rgba(0,0,0,.06),0 24px 60px rgba(0,0,0,.14);overflow:hidden;display:flex;flex-direction:column;opacity:0;transform:translateY(24px) scale(.96);transition:opacity .32s,transform .4s cubic-bezier(.22,1,.36,1);}
.notes-panel.show .notes-card{opacity:1;transform:none;}
.notes-top{height:5px;background:var(--ink);flex-shrink:0;}
.notes-header{display:flex;align-items:center;justify-content:space-between;padding:12px 20px;border-bottom:1px solid var(--border);flex-shrink:0;}
.notes-title{font-family:'Barlow Condensed',sans-serif;font-size:22px;font-weight:900;letter-spacing:2px;}
.notes-close{font-family:'DM Mono',monospace;font-size:10px;letter-spacing:1.5px;text-transform:uppercase;padding:6px 14px;border-radius:20px;background:rgba(0,0,0,.06);color:var(--ink3);border:1px solid var(--border);cursor:pointer;}
.notes-tabs{display:flex;gap:4px;padding:10px 16px 8px;border-bottom:1px solid var(--border);flex-shrink:0;overflow-x:auto;scrollbar-width:none;}
.ntab{font-family:'DM Mono',monospace;font-size:10px;letter-spacing:1.2px;text-transform:uppercase;padding:6px 14px;border-radius:16px;border:none;background:rgba(0,0,0,.05);color:var(--ink3);cursor:pointer;white-space:nowrap;transition:all .18s;}
.ntab.on{background:var(--ink);color:#fff;}
.notes-body{flex:1;overflow-y:auto;padding:16px 20px;}
.n-section{margin-bottom:18px;}
.n-stitle{font-family:'DM Mono',monospace;font-size:10px;letter-spacing:2px;text-transform:uppercase;color:var(--red);margin-bottom:8px;}
.n-item{font-family:'Instrument Sans',sans-serif;font-size:14px;line-height:1.55;color:var(--ink2);padding:6px 0;border-bottom:1px dashed rgba(0,0,0,.07);}
.n-item:last-child{border-bottom:none;}
.n-item strong{color:var(--ink);font-weight:600;}

/* CRER INFOGRAPHIC */
.crer-wrap{flex:1;min-height:0;display:flex;flex-direction:column;padding:50px 22px 6px;overflow:hidden;}
.crer-kicker{font-family:'DM Mono',monospace;font-size:10px;letter-spacing:3px;text-transform:uppercase;color:var(--ink3);margin-bottom:7px;flex-shrink:0;}
.crer-title{font-family:'Barlow Condensed',sans-serif;font-size:clamp(26px,5vw,36px);font-weight:900;line-height:.9;letter-spacing:1px;color:var(--ink);flex-shrink:0;margin-bottom:14px;}
.crer-title em{font-style:normal;color:var(--red);}
.crer-oup{font-family:'DM Mono',monospace;font-size:9px;letter-spacing:1.5px;text-transform:uppercase;color:var(--ink3);margin-bottom:14px;flex-shrink:0;padding:4px 10px;background:rgba(0,0,0,.04);border-radius:20px;display:inline-flex;align-items:center;gap:5px;border:1px solid var(--border);}
.crer-steps{display:flex;flex-direction:column;gap:0;flex:1;min-height:0;justify-content:center;}
.crer-step{display:flex;align-items:stretch;gap:0;flex-shrink:0;}
.crer-letter-col{width:44px;display:flex;flex-direction:column;align-items:center;flex-shrink:0;}
.crer-letter{font-family:'Barlow Condensed',sans-serif;font-size:30px;font-weight:900;line-height:1;width:40px;height:40px;display:flex;align-items:center;justify-content:center;border-radius:10px;flex-shrink:0;}
.crer-connector{width:3px;flex:1;margin:2px auto 2px;border-radius:2px;min-height:8px;}
.crer-step:last-child .crer-connector{display:none;}
.crer-content{flex:1;padding:7px 0 10px 12px;}
.crer-role{font-family:'DM Mono',monospace;font-size:9px;letter-spacing:2px;text-transform:uppercase;font-weight:600;margin-bottom:3px;}
.crer-pills{display:flex;flex-wrap:wrap;gap:4px;margin-top:5px;}
.crer-pill{font-family:'DM Mono',monospace;font-size:8px;letter-spacing:.5px;padding:3px 8px;border-radius:20px;background:rgba(0,0,0,.05);color:var(--ink3);white-space:nowrap;}

.flash{position:fixed;inset:0;z-index:900;pointer-events:none;opacity:0;transition:opacity .08s;background:var(--red);}
.flash.pop{opacity:.04;transition:opacity 0s;}
.fem{position:fixed;pointer-events:none;z-index:800;font-size:20px;animation:femUp 2s ease-out forwards;}
@keyframes femUp{0%{opacity:0;transform:translateY(0) scale(.5);}15%{opacity:1;transform:translateY(-10px) scale(1.1);}80%{opacity:.8;transform:translateY(-90px);}100%{opacity:0;transform:translateY(-130px);}}
.swipe-hint{position:absolute;bottom:16px;left:50%;transform:translateX(-50%);font-family:'DM Mono',monospace;font-size:10px;letter-spacing:3px;text-transform:uppercase;color:var(--ink3);animation:ph 2.5s ease-in-out infinite;pointer-events:none;white-space:nowrap;}
@keyframes ph{0%,100%{opacity:.14}50%{opacity:.3}}
@media(max-width:400px){.tab-btn{font-size:9px;padding:7px 10px;}}
@media(max-height:600px){.poster{height:min(440px,72vh);}}
</style>
</head>
<body>
<div class="shell">
  <div class="topbar">
    <div class="logo">ESSAY<span>_</span>BUILDER</div>
    <div class="spacer"></div>
    <div class="tbctr" id="ctr">1 / 5</div>
  </div>

  <div class="stage" id="stage">
    <!-- SC0: OVERVIEW -->
    <div class="scene active" id="sc0">
      <div class="poster">
        <div class="flag"><div class="flag-body" style="background:var(--red)"><span class="flag-num">ESSAY</span></div></div>
        <div class="section-lbl" style="color:var(--red)">B2 WRITING</div>
        <div style="padding:54px 26px 6px 28px;flex-shrink:0;">
          <div style="font-family:'DM Mono',monospace;font-size:10px;letter-spacing:3px;text-transform:uppercase;color:var(--ink3);margin-bottom:6px;">TODAY'S LESSON</div>
          <div style="font-family:'Barlow Condensed',sans-serif;font-size:clamp(32px,6vw,44px);font-weight:900;line-height:.9;letter-spacing:1px;color:var(--ink);">HOW TO <span style="color:var(--red);">WRITE</span> AN ESSAY</div>
          <div style="display:flex;gap:6px;flex-wrap:wrap;margin-top:10px;">
            <span style="font-family:'DM Mono',monospace;font-size:9px;letter-spacing:1px;padding:3px 9px;border-radius:20px;text-transform:uppercase;background:var(--red-s);color:var(--red);border:1px solid rgba(201,20,15,.14)">Opinion Essay</span>
            <span style="font-family:'DM Mono',monospace;font-size:9px;letter-spacing:1px;padding:3px 9px;border-radius:20px;text-transform:uppercase;background:rgba(0,0,0,.05);color:var(--ink3);border:1px solid var(--border)">140‚Äì190 words</span>
            <span style="font-family:'DM Mono',monospace;font-size:9px;letter-spacing:1px;padding:3px 9px;border-radius:20px;text-transform:uppercase;background:rgba(0,0,0,.05);color:var(--ink3);border:1px solid var(--border)">5 paragraphs</span>
          </div>
        </div>
        <div style="flex:1;min-height:0;padding:4px 28px 4px;display:flex;flex-direction:column;justify-content:center;gap:12px;overflow:hidden;">
          <div style="display:flex;align-items:baseline;gap:14px;flex-shrink:0;">
            <div style="font-family:'Barlow Condensed',sans-serif;font-size:18px;font-weight:900;color:#3d9e95;min-width:26px;">P1</div>
            <div><div style="font-family:'Barlow Condensed',sans-serif;font-size:20px;font-weight:900;letter-spacing:1px;color:var(--ink);line-height:1.1;">INTRODUCTION</div>
            <div style="font-family:'Instrument Sans',sans-serif;font-size:13px;color:var(--ink3);margin-top:2px;">Hook + Thesis statement</div></div>
          </div>
          <div style="display:flex;align-items:baseline;gap:14px;flex-shrink:0;">
            <div style="font-family:'Barlow Condensed',sans-serif;font-size:18px;font-weight:900;color:var(--red);min-width:26px;">P2</div>
            <div><div style="font-family:'Barlow Condensed',sans-serif;font-size:20px;font-weight:900;letter-spacing:1px;color:var(--ink);line-height:1.1;">BODY PARAGRAPH 1</div>
            <div style="font-family:'Instrument Sans',sans-serif;font-size:13px;color:var(--ink3);margin-top:2px;">Claim ‚Üí Reason ‚Üí Example ‚Üí Result</div></div>
          </div>
          <div style="display:flex;align-items:baseline;gap:14px;flex-shrink:0;">
            <div style="font-family:'Barlow Condensed',sans-serif;font-size:18px;font-weight:900;color:var(--red);min-width:26px;">P3</div>
            <div><div style="font-family:'Barlow Condensed',sans-serif;font-size:20px;font-weight:900;letter-spacing:1px;color:var(--ink);line-height:1.1;">BODY PARAGRAPH 2</div>
            <div style="font-family:'Instrument Sans',sans-serif;font-size:13px;color:var(--ink3);margin-top:2px;">Claim ‚Üí Reason ‚Üí Example ‚Üí Result</div></div>
          </div>
          <div style="display:flex;align-items:baseline;gap:14px;flex-shrink:0;">
            <div style="font-family:'Barlow Condensed',sans-serif;font-size:18px;font-weight:900;color:#7b5ea7;min-width:26px;">P4</div>
            <div><div style="font-family:'Barlow Condensed',sans-serif;font-size:20px;font-weight:900;letter-spacing:1px;color:var(--ink);line-height:1.1;">BODY PARAGRAPH 3 <span style="color:#7b5ea7;font-size:13px;">‚òÖ own idea</span></div>
            <div style="font-family:'Instrument Sans',sans-serif;font-size:13px;color:var(--ink3);margin-top:2px;">Your original point ‚Äî required for full marks</div></div>
          </div>
          <div style="display:flex;align-items:baseline;gap:14px;flex-shrink:0;">
            <div style="font-family:'Barlow Condensed',sans-serif;font-size:18px;font-weight:900;color:#2d7a3a;min-width:26px;">P5</div>
            <div><div style="font-family:'Barlow Condensed',sans-serif;font-size:20px;font-weight:900;letter-spacing:1px;color:var(--ink);line-height:1.1;">CONCLUSION</div>
            <div style="font-family:'Instrument Sans',sans-serif;font-size:13px;color:var(--ink3);margin-top:2px;">Restate opinion ¬∑ No new ideas</div></div>
          </div>
        </div>
        <div class="card-dots-row">
          <button class="card-arrow" onclick="prevScene()" disabled>‚Äπ</button>
          <div class="dots" id="dots0"></div>
          <button class="card-arrow" onclick="nextScene()">‚Ä∫</button>
        </div>
        <div class="accent-bar" style="background:var(--red)"></div>
      </div>
      <div class="swipe-hint">tap ‚ñ∂ to begin</div>

    </div>

    <!-- SC1: QUESTION + INTRO PAIRS -->
    <div class="scene" id="sc1">
      <div class="poster">
        <div class="flag"><div class="flag-body" style="background:var(--c-intro)"><span class="flag-num">INTRODUCTION</span></div></div>
        <div class="section-lbl" style="color:var(--c-intro)">THE QUESTION</div>
        <div style="flex:1;min-height:0;display:flex;flex-direction:column;padding:58px 28px 10px;">
          <div style="font-family:'DM Mono',monospace;font-size:10px;letter-spacing:3px;text-transform:uppercase;color:var(--ink3);margin-bottom:14px;flex-shrink:0;">üì± Today's essay question</div>
          <div style="font-family:'Barlow Condensed',sans-serif;font-size:clamp(30px,5.5vw,42px);font-weight:900;line-height:.95;letter-spacing:1px;color:var(--ink);flex-shrink:0;">Should the use of phones be <span style="color:var(--red);">limited</span> for young people?</div>
          <div style="flex:1;"></div>
          <div style="font-family:'Instrument Sans',sans-serif;font-size:16px;line-height:1.5;color:var(--ink2);margin-bottom:18px;flex-shrink:0;">What do <strong style="color:var(--ink);">you</strong> think? Pick your side.</div>
          <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;flex-shrink:0;margin-bottom:12px;">
            <div style="text-align:center;padding:12px 8px;border-top:2px solid #16a34a;">
              <div style="font-family:'Barlow Condensed',sans-serif;font-size:28px;font-weight:900;color:#16a34a;line-height:1;">YES</div>
              <div style="font-family:'DM Mono',monospace;font-size:10px;letter-spacing:1px;color:var(--ink3);margin-top:3px;">limit them</div>
            </div>
            <div style="text-align:center;padding:12px 8px;border-top:2px solid var(--ink3);">
              <div style="font-family:'Barlow Condensed',sans-serif;font-size:28px;font-weight:900;color:var(--ink2);line-height:1;">MAYBE</div>
              <div style="font-family:'DM Mono',monospace;font-size:10px;letter-spacing:1px;color:var(--ink3);margin-top:3px;">it depends</div>
            </div>
            <div style="text-align:center;padding:12px 8px;border-top:2px solid var(--red);">
              <div style="font-family:'Barlow Condensed',sans-serif;font-size:28px;font-weight:900;color:var(--red);line-height:1;">NO</div>
              <div style="font-family:'DM Mono',monospace;font-size:10px;letter-spacing:1px;color:var(--ink3);margin-top:3px;">let them</div>
            </div>
          </div>
        </div>
        <div class="card-dots-row">
          <button class="card-arrow" onclick="prevScene()">‚Äπ</button>
          <div class="dots" id="dots1"></div>
          <button class="card-arrow" onclick="nextScene()">‚Ä∫</button>
        </div>
        <div class="accent-bar" style="background:var(--c-intro)"></div>
      </div>
    </div>

    <!-- SC2: REST SLIDE ‚Äî breath before the examples -->
    <div class="scene" id="sc2">
      <div class="poster">
        <div class="flag"><div class="flag-body" style="background:var(--red)"><span class="flag-num">BODY PARAGRAPHS</span></div></div>
        <div class="section-lbl" style="color:var(--red)">STRUCTURE</div>
        <div style="flex:1;min-height:0;display:flex;flex-direction:column;padding:56px 26px 8px 28px;gap:0;overflow:hidden;">

          <!-- CLAIM block -->
          <div style="flex-shrink:0;margin-bottom:14px;">
            <div style="font-family:'Barlow Condensed',sans-serif;font-size:clamp(38px,8vw,58px);font-weight:900;line-height:.85;letter-spacing:1px;color:var(--ink);">CLAIM</div>
            <div style="display:flex;flex-wrap:wrap;gap:5px;margin-top:10px;">
              <span style="font-family:'DM Mono',monospace;font-size:9px;letter-spacing:.5px;padding:4px 9px;border-radius:3px;background:var(--red);color:#fff;">listing marker</span>
              <span style="font-family:'DM Mono',monospace;font-size:9px;letter-spacing:.5px;padding:4px 9px;border-radius:3px;background:var(--red);color:#fff;">expressing a view</span>
              <span style="font-family:'DM Mono',monospace;font-size:9px;letter-spacing:.5px;padding:4px 9px;border-radius:3px;background:var(--red);color:#fff;">making a claim</span>
            </div>
          </div>

          <!-- Divider -->
          <div style="height:1px;background:rgba(0,0,0,.08);flex-shrink:0;margin-bottom:14px;"></div>

          <!-- SUPPORT block -->
          <div style="flex-shrink:0;">
            <div style="font-family:'Barlow Condensed',sans-serif;font-size:clamp(24px,5vw,36px);font-weight:900;line-height:.9;letter-spacing:1px;color:var(--ink3);margin-bottom:10px;">SUPPORT <span style="font-size:.55em;color:rgba(28,28,30,.35);letter-spacing:2px;">or develop</span></div>
            <div style="display:flex;flex-wrap:wrap;gap:5px;">
              <span style="font-family:'DM Mono',monospace;font-size:9px;letter-spacing:.5px;padding:4px 9px;border-radius:3px;background:rgba(0,0,0,.06);color:var(--ink3);">reason</span>
              <span style="font-family:'DM Mono',monospace;font-size:9px;letter-spacing:.5px;padding:4px 9px;border-radius:3px;background:rgba(0,0,0,.06);color:var(--ink3);">explain</span>
              <span style="font-family:'DM Mono',monospace;font-size:9px;letter-spacing:.5px;padding:4px 9px;border-radius:3px;background:rgba(0,0,0,.06);color:var(--ink3);">example</span>
              <span style="font-family:'DM Mono',monospace;font-size:9px;letter-spacing:.5px;padding:4px 9px;border-radius:3px;background:rgba(0,0,0,.06);color:var(--ink3);">rephrase</span>
              <span style="font-family:'DM Mono',monospace;font-size:9px;letter-spacing:.5px;padding:4px 9px;border-radius:3px;background:rgba(0,0,0,.06);color:var(--ink3);">result</span>
              <span style="font-family:'DM Mono',monospace;font-size:9px;letter-spacing:.5px;padding:4px 9px;border-radius:3px;background:rgba(0,0,0,.06);color:var(--ink3);">compare</span>
              <span style="font-family:'DM Mono',monospace;font-size:9px;letter-spacing:.5px;padding:4px 9px;border-radius:3px;background:rgba(0,0,0,.06);color:var(--ink3);">contrast</span>
            </div>
          </div>

        </div>
        <div class="card-dots-row">
          <button class="card-arrow" onclick="prevScene()">‚Äπ</button>
          <div class="dots" id="dots2"></div>
          <button class="card-arrow" onclick="nextScene()">‚Ä∫</button>
        </div>
        <div class="accent-bar" style="background:var(--red)"></div>
      </div>
    </div>

    <!-- SC3: CRER STRUCTURE INFOGRAPHIC -->
    <div class="scene" id="sc3">
      <div class="poster">
        <div class="flag"><div class="flag-body" style="background:var(--red)"><span class="flag-num">BODY PARAGRAPHS</span></div></div>
        <div class="section-lbl" style="color:var(--red)">STRUCTURE</div>
        <div class="crer-wrap">
          <div class="crer-kicker">A guide ‚Äî not a rule</div>
          <div class="crer-title">Claim + <em>Support</em><br><span style="font-size:.6em;color:var(--ink3);letter-spacing:2px;">or development</span></div>
          <div class="crer-oup">üìò Use what fits ¬∑ mix and match</div>
          <div class="crer-steps">
            <div class="crer-step">
              <div class="crer-letter-col">
                <div class="crer-letter" style="background:#c9140f;color:#fff;">C</div>
                <div class="crer-connector" style="background:rgba(201,20,15,0.18);"></div>
              </div>
              <div class="crer-content">
                <div class="crer-role" style="color:#c9140f;">CLAIM ‚Äî your point</div>
                <div class="crer-pills">
                  <span class="crer-pill">Firstly,</span><span class="crer-pill">Furthermore,</span><span class="crer-pill">In addition,</span><span class="crer-pill">However,</span><span class="crer-pill">On the other hand,</span>
                </div>
                <div style="font-family:'DM Mono',monospace;font-size:8px;letter-spacing:.8px;color:rgba(0,0,0,.35);margin-top:5px;line-height:1.5;">+ In my opinion, ¬∑ As far as I am concerned, ¬∑ It could be argued that</div>
              </div>
            </div>
            <div class="crer-step">
              <div class="crer-letter-col">
                <div class="crer-letter" style="background:#1a6b3c;color:#fff;">R</div>
                <div class="crer-connector" style="background:rgba(26,107,60,0.18);"></div>
              </div>
              <div class="crer-content">
                <div class="crer-role" style="color:#1a6b3c;">REASON ‚Äî explain why</div>
                <div class="crer-pills">
                  <span class="crer-pill">This is because‚Ä¶</span><span class="crer-pill">This is largely due to‚Ä¶</span><span class="crer-pill">Since‚Ä¶</span>
                </div>
              </div>
            </div>
            <div class="crer-step">
              <div class="crer-letter-col">
                <div class="crer-letter" style="background:#1a5c8a;color:#fff;">E</div>
                <div class="crer-connector" style="background:rgba(26,92,138,0.18);"></div>
              </div>
              <div class="crer-content">
                <div class="crer-role" style="color:#1a5c8a;">EXAMPLE ‚Äî give evidence</div>
                <div class="crer-pills">
                  <span class="crer-pill">For instance,</span><span class="crer-pill">For example,</span><span class="crer-pill">Indeed,</span>
                </div>
              </div>
            </div>
            <div class="crer-step">
              <div class="crer-letter-col">
                <div class="crer-letter" style="background:#6b4ea8;color:#fff;">R</div>
              </div>
              <div class="crer-content">
                <div class="crer-role" style="color:#6b4ea8;">RESULT ‚Äî the consequence</div>
                <div class="crer-pills">
                  <span class="crer-pill">As a result,</span><span class="crer-pill">Consequently,</span><span class="crer-pill">Therefore,</span>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="card-dots-row">
          <button class="card-arrow" onclick="prevScene()">‚Äπ</button>
          <div class="dots" id="dots3"></div>
          <button class="card-arrow" onclick="nextScene()">‚Ä∫</button>
        </div>
        <div class="accent-bar" style="background:var(--red)"></div>
      </div>
    </div>


    <!-- SC4: CONCLUSION -->
    <div class="scene" id="sc4">
      <div class="poster">
        <div class="flag"><div class="flag-body" style="background:var(--c-conc)"><span class="flag-num">CONCLUSION</span></div></div>
        <div class="section-lbl" style="color:var(--c-conc)">CONCLUSION</div>
        <div style="flex:1;min-height:0;display:flex;flex-direction:column;padding:58px 26px 4px 28px;overflow:hidden;">
          <div style="font-family:'DM Mono',monospace;font-size:10px;letter-spacing:3px;text-transform:uppercase;color:rgba(0,0,0,.32);margin-bottom:10px;flex-shrink:0;">Paragraph 5 ¬∑ Conclusion</div>
          <div class="sentence-scroll" id="stk4"></div>
        </div>
        <div class="card-dots-row">
          <button class="card-arrow" onclick="prevScene()">‚Äπ</button>
          <div class="dots" id="dots4"></div>
          <button class="card-arrow" onclick="nextScene()" disabled>‚Ä∫</button>
        </div>
        <div class="accent-bar" style="background:var(--c-conc)"></div>
      </div>
    </div>
  </div><!-- /stage -->

  <div class="footer" id="mainFooter">
    <div class="playback-row">
      <div class="wave off" id="wL"><div class="wb"></div><div class="wb"></div><div class="wb"></div><div class="wb"></div><div class="wb"></div></div>
      <button class="btn-nav" id="btnPrev" onclick="prevScene()" disabled>‚Äπ</button>
      <button class="btn-play" id="btnPlay" onclick="handlePlay()">‚ñ∂</button>
      <button class="btn-nav" id="btnNext" onclick="nextScene()">‚Ä∫</button>
      <div class="wave off" id="wR"><div class="wb"></div><div class="wb"></div><div class="wb"></div><div class="wb"></div><div class="wb"></div></div>
    </div>
    <div class="tab-bar-wrap">
      <div class="tab-bar">
        <button class="tab-btn active" data-tab="intro" onclick="jumpTab('intro')">INTRODUCTION</button>
        <button class="tab-btn" data-tab="body" onclick="jumpTab('body')">BODY</button>
        <button class="tab-btn" data-tab="conc" onclick="jumpTab('conc')">CONCLUSION</button>
        <button class="tab-btn" data-tab="notes" onclick="jumpTab('notes')">USEFUL NOTES</button>
      </div>
    </div>
  </div>
</div>

<!-- INTERSTITIAL -->
<div class="inter-ov" id="interOv">
  <div class="inter-card">
    <div class="inter-flag"><div class="inter-flag-body" id="interFlagBody"><span class="inter-flag-num" id="interFlagNum"></span></div></div>
    <div class="inter-body">
      <div class="inter-kicker" id="interKicker"></div>
      <div class="inter-big" id="interBig"></div>
      <div class="inter-sub" id="interSub"></div>
    </div>
    <div class="inter-bottom" id="interBottom"></div>
  </div>
</div>

<!-- INTRO PAIRS OVERLAY -->
<div class="ov" id="ov" onclick="if(event.target===this){hardStop();updateNavBtns();}">
  <div class="ob" id="ob">
    <div class="ob-flag"><div class="ob-flag-body"><span class="ob-flag-num">INTRODUCTION</span></div></div>
    <div class="ob-pair-lbl" id="obNum">1 / 5</div>
    <div class="ob-body">
      <div class="ob-hlbl">ü™ù HOOK</div>
      <div class="ob-starter" id="obS"></div>
      <div class="ob-rest" id="obR"></div>
      <div class="ob-link" id="obL"></div>
      <div class="ob-sep"></div>
      <div>
        <div class="ob-tlbl">üìå THESIS</div>
        <div class="ob-tt" id="obT"></div>
      </div>
    </div>
    <div class="ob-foot">
      <button class="ob-stop" onclick="hardStop();updateNavBtns()">&#9632; &nbsp;STOP</button>
    </div>
    <div class="ob-bottom"></div>
  </div>
  <div class="ob-dots" id="obDots"></div>
</div>

<!-- BODY PARAGRAPH PAIRS OVERLAY -->
<div class="bov" id="bov" onclick="if(event.target===this){hardStop();updateNavBtns();}">
  <div class="bob" id="bob">
    <div class="bob-flag"><div class="bob-flag-body" id="bobFlagBody"><span class="bob-flag-num" id="bobFlagNum">BODY PARAGRAPH</span></div></div>
    <div class="bob-pair-lbl" id="bobNum">1 / 5</div>
    <div class="bob-body" id="bobBody"></div>
    <div class="bob-foot">
      <button class="bob-stop" onclick="hardStop();updateNavBtns()">&#9632; &nbsp;STOP</button>
    </div>
    <div class="bob-bottom" id="bobBottom"></div>
  </div>
  <div class="bob-dots" id="bobDots"></div>
</div>

<!-- NOTES PANEL -->
<div class="notes-panel" id="notesPanel">
  <div class="notes-card">
    <div class="notes-top"></div>
    <div class="notes-header">
      <div class="notes-title">üìã USEFUL NOTES</div>
      <button class="notes-close" onclick="closeNotes()">‚úï Close</button>
    </div>
    <div class="notes-tabs">
      <button class="ntab on" data-ntab="descriptors" onclick="switchNtab('descriptors')">üìã Descriptors</button>
      <button class="ntab" data-ntab="linking" onclick="switchNtab('linking')">üîó Linking</button>
      <button class="ntab" data-ntab="planning" onclick="switchNtab('planning')">üìù Planning</button>
      <button class="ntab" data-ntab="wordlimit" onclick="switchNtab('wordlimit')">üî¢ Word Limit</button>
    </div>
    <div class="notes-body" id="notesBody"></div>
  </div>
</div>

<div class="flash" id="flash"></div>

<script>
const SCENE_COUNT = 5;

/* Measure real footer height and update CSS variable */
function updateFooterVar(){
  const f=document.getElementById('mainFooter');
  if(f)document.documentElement.style.setProperty('--footer-h',f.offsetHeight+'px');
}

/* ‚îÄ‚îÄ‚îÄ DATA ‚îÄ‚îÄ‚îÄ */
const NOTES_DATA = {
  descriptors:[
    {title:'Content (25%)',items:['<strong>Answer the question directly.</strong> Include both given ideas plus your own third idea.','Each point must be developed ‚Äî not just stated.','Missing the third idea = automatic loss of marks.']},
    {title:'Communicative Achievement (25%)',items:['<strong>Formal register throughout.</strong> No contractions, no slang.','Every claim needs a reason or example.','Never "I think" ‚Äî use "In my opinion" or "It seems to me that".']},
    {title:'Organisation (25%)',items:['<strong>Clear paragraphs</strong> with a topic sentence in each.','Logical: claim ‚Üí reason ‚Üí example ‚Üí result.','Different linking word to begin each paragraph.']},
    {title:'Language (25%)',items:['<strong>Range of vocabulary</strong> ‚Äî avoid repetition.','Variety of grammar: passive, relative clauses, conditionals.','Accurate spelling and punctuation.']}
  ],
  linking:[
    {title:'Opening each paragraph ‚Äî use a DIFFERENT one each time',items:[
      '"Firstly," ¬∑ "Furthermore," ¬∑ "In addition," ¬∑ "However," ¬∑ "On the other hand,"',
      '‚ö†Ô∏è Never use "Secondly," in a B2 First for Schools essay ‚Äî it sounds like a list, not an argument.',
      '‚ö†Ô∏è Never repeat the same opening marker across two paragraphs ‚Äî the examiner notices.'
    ]},
    {title:'Opinion (Cambridge corpus)',items:['"In my opinion," ¬∑ "As far as I am concerned," ¬∑ "It could be argued that" ¬∑ "I firmly believe that"']},
    {title:'Reason (Cambridge corpus)',items:['"This is because" ¬∑ "This is largely due to the fact that" ¬∑ "The main reason for this is that"']},
    {title:'Example (Cambridge corpus)',items:['"For instance," ¬∑ "For example," ¬∑ "This can be seen in the fact that"']},
    {title:'Result (Cambridge corpus)',items:['"As a result," ¬∑ "Consequently," ¬∑ "As a consequence," ¬∑ "This means that"']},
    {title:'Concluding (Cambridge corpus)',items:['"In conclusion," ¬∑ "To sum up," ¬∑ "All things considered," ¬∑ "On the whole,"']}
  ],
  planning:[
    {title:'The 5-minute exam plan',items:['<strong>Read twice.</strong> Underline the two given ideas.','Decide: agree / disagree / balanced.','Jot 2‚Äì3 keywords per paragraph ‚Äî not full sentences.','Decide your OWN third idea BEFORE you start writing.']},
    {title:'What every body paragraph needs',items:['<strong>A clear claim</strong> ‚Äî open with a viewpoint marker + your point.','<strong>Support</strong> ‚Äî illustrate, explain, develop it. Any combination works: a reason, an example, a result, a contrast, a statistic. Use what fits.','Two or three sentences of support is plenty at 190 words.']},
    {title:'What the CRER labels actually mean',items:['C¬∑R¬∑E¬∑R is a <strong>guide, not a rule.</strong> It shows one way to build support.','You do not need all four steps. You do not need them in order.','Focus on making your point clear and convincing ‚Äî the labels will look after themselves.']},
    {title:'Common mistakes',items:['Starting without knowing what your own third idea will be.','Copying phrases from the question ‚Äî always rephrase.','Using the same opening marker in two paragraphs ‚Äî vary them.']}
  ],
  wordlimit:[
    {title:'Target: 140‚Äì190 words',items:['<strong>Under 130 = automatic mark penalty.</strong>','190 words = roughly 12‚Äì15 sentences across 5 paragraphs.','Intro 2‚Äì3 ¬∑ Each body 3‚Äì4 ¬∑ Conclusion 2‚Äì3.']},
    {title:'Quick fixes if too short',items:['Add a result sentence to each body paragraph.','Expand your example ‚Äî name a place, study, or statistic.','Add a concession in P4: "While some argue that‚Ä¶ I believe‚Ä¶"']}
  ]
};

const PAIRS = [
  { s:'Nowadays,', r:'smartphones are used by millions of young people around the world every single day.',
    f:'Nowadays, smartphones are used by millions of young people around the world every single day.',
    link:'Although this technology brings undeniable benefits, there is growing concern about its impact on young people\'s health and education.',
    linkHtml:'<span style="color:var(--red);font-weight:700">Although</span> this technology brings undeniable benefits, there is growing concern about its impact on young people\'s health and education.',
    t:'This essay will discuss the main <strong>advantages and disadvantages</strong> of limiting smartphone use.',
    tf:'This essay will discuss the main advantages and disadvantages of limiting smartphone use.' },
  { s:'In recent years,', r:'there has been a growing debate about whether young people should have unlimited access to their phones.',
    f:'In recent years, there has been a growing debate about whether young people should have unlimited access to their phones.',
    link:'Despite the many educational opportunities that smartphones provide, concerns about their negative effects continue to increase.',
    linkHtml:'<span style="color:var(--red);font-weight:700">Despite</span> the many educational opportunities that smartphones provide, concerns about their negative effects continue to increase.',
    t:'In this essay, I will examine <strong>both sides of the argument</strong> before giving my personal opinion.',
    tf:'In this essay, I will examine both sides of the argument before giving my personal opinion.' },
  { s:'It is widely believed that', r:'smartphone use has fundamentally changed the way young people learn, communicate and relax.',
    f:'It is widely believed that smartphone use has fundamentally changed the way young people learn, communicate and relax.',
    link:'However, it is becoming increasingly clear that unrestricted use may have serious consequences for young people\'s wellbeing.',
    linkHtml:'<span style="color:var(--red);font-weight:700">However,</span> it is becoming increasingly clear that unrestricted use may have serious consequences for young people\'s wellbeing.',
    t:'Therefore, it is essential to discuss <strong>the benefits and drawbacks</strong> of restricting these devices.',
    tf:'Therefore, it is essential to discuss the benefits and drawbacks of restricting these devices.' },
  { s:'Many people argue that', r:'excessive smartphone use is one of the most serious challenges facing young people today.',
    f:'Many people argue that excessive smartphone use is one of the most serious challenges facing young people today.',
    link:'Since smartphones have become such a central part of daily life, the question of how to regulate their use has never been more important.',
    linkHtml:'<span style="color:var(--red);font-weight:700">Since</span> smartphones have become such a central part of daily life, the question of how to regulate their use has never been more important.',
    t:'The aim of this essay is to consider <strong>whether limiting smartphones</strong> would truly benefit young people.',
    tf:'The aim of this essay is to consider whether limiting smartphones would truly benefit young people.' },
  { s:'It is impossible to deny that', r:'smartphones play a significant role in the daily lives of young people worldwide.',
    f:'It is impossible to deny that smartphones play a significant role in the daily lives of young people worldwide.',
    link:'Nevertheless, with growing evidence of the harm caused by excessive screen time, it is vital that we consider whether some form of restriction is necessary.',
    linkHtml:'<span style="color:var(--red);font-weight:700">Nevertheless,</span> with growing evidence of the harm caused by excessive screen time, it is vital that we consider whether some form of restriction is necessary.',
    t:'This essay will argue that <strong>some restrictions</strong> on smartphone use are both necessary and beneficial.',
    tf:'This essay will argue that some restrictions on smartphone use are both necessary and beneficial.' }
];

const BODY_PAIRS = [
  { color:'#c9140f', flagTitle:'BODY PARAGRAPH 1', topic:'üìù P2 ‚Äî FIRST POINT',
    starter:'Firstly,',
    opinion:'in my opinion,',
    keyExpr:'the main advantage of limiting phones',
    rest:" is improved concentration. This is because apps are designed to interrupt attention constantly. As a result, phone-free schools have reported significant improvements in focus and academic results.",
    links:['This is because','As a result,'],
    note:'Open with a listing marker + your opinion. Name the advantage or drawback clearly, then support it.'
  },
  { color:'#c9140f', flagTitle:'BODY PARAGRAPH 2', topic:'üí° P3 ‚Äî SECOND POINT',
    starter:'Furthermore,',
    opinion:'it seems to me that',
    keyExpr:'one key drawback of unrestricted phone use',
    rest:" is the damage it does to sleep. Screen light suppresses melatonin and, consequently, tired students struggle to perform well in class.",
    links:['consequently,'],
    note:'Vary your listing marker and opinion phrase each time. Name the drawback, then illustrate it.'
  },
  { color:'#7b5ea7', flagTitle:'BODY PARAGRAPH 3 ‚òÖ', topic:'‚≠ê P4 ‚Äî YOUR OWN IDEA',
    starter:'In addition,',
    opinion:'as far as I am concerned,',
    keyExpr:'one often overlooked disadvantage',
    rest:" is the effect on social skills. Face-to-face communication ‚Äî reading emotions, handling disagreement ‚Äî needs real practice. Therefore, heavy phone use may leave young people less prepared for adult life.",
    links:['Therefore,'],
    note:'This point must be your own ‚Äî not one from the question. Any support that develops your idea works.'
  }
];

const CONCL_DATA = [
  {role:'SUMMARY', kw:'In conclusion,',     text:"In conclusion, I firmly believe that the question of smartphone use for young people requires careful and balanced consideration."},
  {role:'POINT 1', kw:'On one hand,',       text:"On one hand, restricting phones leads to improved academic performance, better sleep, and greater overall wellbeing."},
  {role:'POINT 2', kw:'On the other hand,', text:"On the other hand, smartphones offer genuine educational value and should not be dismissed as purely harmful."},
  {role:'REWORD',  kw:'In other words,',    text:"In other words, it is not the phone itself that is the problem ‚Äî it is how, when, and for how long it is used."},
  {role:'VERDICT', kw:'Overall,',           text:"Overall, a measured and balanced approach to limiting smartphone use would benefit the vast majority of young people."}
];

/* ‚îÄ‚îÄ‚îÄ STATE ‚îÄ‚îÄ‚îÄ */
let cur=0, running=false, bannerOn=false, bodyBannerOn=false, gen=0;

/* ‚îÄ‚îÄ‚îÄ SPEECH ‚îÄ‚îÄ‚îÄ */
const synth=window.speechSynthesis;
let voice=null;
function loadVoice(){
  const p=()=>{const v=synth.getVoices();voice=v.find(x=>x.name==='Google UK English Male')||v.find(x=>x.name==='Daniel')||v.find(x=>x.lang==='en-GB')||v.find(x=>x.lang&&x.lang.startsWith('en'))||v[0]||null;};
  if(synth.getVoices().length)p();else synth.onvoiceschanged=p;
}
let sRes=null;
function stopSpeech(){if(sRes){sRes();sRes=null;}synth.cancel();}
function speak(t,myGen){
  return new Promise(r=>{
    if(!running||myGen!==gen){r();return;}
    synth.cancel();sRes=r;
    const go=()=>{
      if(!running||myGen!==gen){sRes=null;r();return;}
      const u=new SpeechSynthesisUtterance(t);
      u.voice=voice;u.rate=0.87;u.pitch=1;u.volume=1;
      u.onend=()=>{sRes=null;r();};u.onerror=()=>{sRes=null;r();};
      synth.speak(u);
    };
    setTimeout(go,120);
  });
}
function wait(ms,myGen){return new Promise(r=>setTimeout(()=>r(),(myGen!==undefined&&myGen!==gen)?0:ms));}

/* ‚îÄ‚îÄ‚îÄ HARD STOP ‚îÄ‚îÄ‚îÄ */
function hardStop(){
  gen++;running=false;bannerOn=false;bodyBannerOn=false;
  stopSpeech();waveOff();closeBanner();closeBodyBanner();hideInter();
  const b=document.getElementById('btnPlay');b.textContent='‚ñ∂';b.classList.remove('running');
}

/* ‚îÄ‚îÄ‚îÄ DOTS ‚îÄ‚îÄ‚îÄ */
function buildDots(){
  for(let sc=0;sc<SCENE_COUNT;sc++){
    const c=document.getElementById('dots'+sc);if(!c)continue;
    c.innerHTML='';
    for(let i=0;i<SCENE_COUNT;i++){const d=document.createElement('div');d.className='dot';d.id='d'+sc+'-'+i;c.appendChild(d);}
  }
}
function updateDots(i){
  for(let sc=0;sc<SCENE_COUNT;sc++){
    for(let j=0;j<SCENE_COUNT;j++){
      const d=document.getElementById('d'+sc+'-'+j);if(!d)continue;
      d.classList.remove('active','done');
      if(j===i)d.classList.add('active');else if(j<i)d.classList.add('done');
    }
  }
}

/* ‚îÄ‚îÄ‚îÄ SECTION BOUNDARIES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
   Each section has a final scene. runScene stops (finishSection)
   when the current scene index equals the section's end scene,
   instead of automatically chaining to the next section.
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
const SECTION_END = { intro:1, body:3, conc:4 };
let activeSection = 'intro';

function sectionForScene(idx){
  if(idx<=1)return 'intro';
  if(idx<=3)return 'body';
  return 'conc';
}

/* ‚îÄ‚îÄ‚îÄ TAB SYNC ‚îÄ‚îÄ‚îÄ */
function syncTab(idx){
  const t=sectionForScene(idx);
  document.querySelectorAll('.tab-btn').forEach(b=>b.classList.toggle('active',b.dataset.tab===t));
}
function jumpTab(tab){
  if(tab==='notes'){openNotes();return;}
  hardStop();clearStacks();
  const map={intro:1,body:2,conc:4};
  const target=map[tab];
  if(typeof target==='number'){
    activeSection=tab;
    cur=target;showScene(cur);
    setTimeout(()=>{
      if(!running){
        running=true;const myGen=gen;
        const b=document.getElementById('btnPlay');b.textContent='‚èπ';b.classList.add('running');
        updateNavBtns();runScene(cur,myGen);
      }
    },120);
  }
  updateNavBtns();
}

/* ‚îÄ‚îÄ‚îÄ SCENE ‚îÄ‚îÄ‚îÄ */
function showScene(i){
  document.querySelectorAll('.scene').forEach(s=>s.classList.remove('active'));
  const sc=document.getElementById('sc'+i);if(!sc)return;
  sc.classList.add('active');
  document.getElementById('ctr').textContent=(i+1)+' / '+SCENE_COUNT;
  updateDots(i);syncTab(i);updateNavBtns();flashColor();
  if(i>0)spawnEmoji(i);
}

/* ‚îÄ‚îÄ‚îÄ WAVE ‚îÄ‚îÄ‚îÄ */
function waveOn(){['wL','wR'].forEach(id=>{const w=document.getElementById(id);if(w){w.classList.remove('off');w.classList.add('on');}});}
function waveOff(){['wL','wR'].forEach(id=>{const w=document.getElementById(id);if(w){w.classList.remove('on');w.classList.add('off');}});}

/* ‚îÄ‚îÄ‚îÄ INTERSTITIAL ‚îÄ‚îÄ‚îÄ */
function showInter(flag,fc,kicker,big,sub,ac){
  document.getElementById('interFlagBody').style.background=fc;
  document.getElementById('interFlagNum').textContent=flag;
  document.getElementById('interKicker').textContent=kicker;
  document.getElementById('interBig').innerHTML=big;
  document.getElementById('interSub').innerHTML=sub;
  document.getElementById('interBottom').style.background=fc;
  document.getElementById('interOv').style.setProperty('--inter-accent',ac||fc);
  document.getElementById('interOv').classList.add('show');
}
function hideInter(){document.getElementById('interOv').classList.remove('show');}

/* ‚îÄ‚îÄ‚îÄ NOTES ‚îÄ‚îÄ‚îÄ */
let activeNtab='descriptors';
function renderNotes(tab){
  const body=document.getElementById('notesBody');
  const secs=NOTES_DATA[tab]||[];
  let h='';secs.forEach(s=>{h+=`<div class="n-section"><div class="n-stitle">${s.title}</div>`;s.items.forEach(it=>{h+=`<div class="n-item">${it}</div>`;});h+='</div>';});
  body.innerHTML=h;
}
function switchNtab(t){activeNtab=t;document.querySelectorAll('.ntab').forEach(b=>b.classList.toggle('on',b.dataset.ntab===t));renderNotes(t);}
function openNotes(){renderNotes(activeNtab);document.getElementById('notesPanel').classList.add('show');}
function closeNotes(){document.getElementById('notesPanel').classList.remove('show');syncTab(cur);}

/* ‚îÄ‚îÄ‚îÄ INTRO PAIRS BANNER ‚îÄ‚îÄ‚îÄ */
function closeBanner(){document.getElementById('ov').classList.remove('show');document.getElementById('ob').classList.remove('exit');bannerOn=false;}
async function runPairs(myGen){
  bannerOn=true;
  document.getElementById('obDots').innerHTML=PAIRS.map((_,i)=>`<div class="bdot" id="bd${i}"></div>`).join('');
  document.getElementById('ov').classList.add('show');
  for(let i=0;i<PAIRS.length;i++){if(!running||!bannerOn||myGen!==gen)break;await showPair(PAIRS[i],i,myGen);}
  closeBanner();
}
async function showPair(p,idx,myGen){
  const ob=document.getElementById('ob');
  if(idx>0){ob.classList.add('exit');await wait(190,myGen);if(!running||!bannerOn||myGen!==gen){ob.classList.remove('exit');return;}ob.classList.remove('exit');}
  if(!running||!bannerOn||myGen!==gen)return;
  document.getElementById('obNum').textContent=(idx+1)+' / '+PAIRS.length;
  const sEl=document.getElementById('obS');
  sEl.textContent=p.s;
  const l=p.s.length;
  sEl.style.fontSize=l>22?'clamp(1.35rem,5vw,2.2rem)':l>14?'clamp(1.7rem,6.5vw,2.8rem)':'clamp(2rem,7.5vw,3.3rem)';
  const rEl=document.getElementById('obR'),lEl=document.getElementById('obL'),tEl=document.getElementById('obT');
  rEl.style.cssText='opacity:0;transform:translateY(6px);transition:none;';
  lEl.style.cssText='opacity:0;transform:translateY(4px);transition:none;';
  tEl.style.cssText='opacity:0;transform:translateY(8px);transition:none;';
  rEl.textContent=p.r;lEl.innerHTML=p.linkHtml;tEl.innerHTML=p.t;
  await wait(24,myGen);
  rEl.style.cssText='';lEl.style.cssText='';tEl.style.cssText='';
  for(let i=0;i<PAIRS.length;i++){const d=document.getElementById('bd'+i);if(d){d.classList.toggle('active',i===idx);d.classList.toggle('done',i<idx);}}
  waveOn();
  await speak(p.f,myGen);if(!running||!bannerOn||myGen!==gen)return;
  await wait(140,myGen);
  await speak(p.link,myGen);if(!running||!bannerOn||myGen!==gen)return;
  await wait(140,myGen);
  await speak(p.tf,myGen);if(!running||!bannerOn||myGen!==gen)return;
  waveOff();
  await wait(460,myGen);
}

/* ‚îÄ‚îÄ‚îÄ BODY PARAGRAPH BANNER ‚îÄ‚îÄ‚îÄ */
function closeBodyBanner(){
  document.getElementById('bov').classList.remove('show');
  document.getElementById('bob').classList.remove('exit');
  bodyBannerOn=false;
}

async function runBodyPairs(myGen){
  bodyBannerOn=true;
  document.getElementById('bobDots').innerHTML=BODY_PAIRS.map((_,i)=>`<div class="bdot" id="bbd${i}"></div>`).join('');
  document.getElementById('bov').classList.add('show');
  for(let i=0;i<BODY_PAIRS.length;i++){
    if(!running||!bodyBannerOn||myGen!==gen)break;
    await showBodyPair(BODY_PAIRS[i],i,myGen);
  }
  /* FIX 1: Always close banner after loop ‚Äî whether completed or interrupted */
  closeBodyBanner();
  /* runScene continuation happens in the caller after this await resolves */
}

async function showBodyPair(para,idx,myGen){
  const bob=document.getElementById('bob');
  if(idx>0){
    bob.classList.add('exit');
    await wait(190,myGen);
    if(!running||!bodyBannerOn||myGen!==gen){bob.classList.remove('exit');return;}
    bob.classList.remove('exit');
  }
  if(!running||!bodyBannerOn||myGen!==gen)return;

  document.getElementById('bobNum').textContent=(idx+1)+' / '+BODY_PAIRS.length;
  document.getElementById('bobFlagNum').textContent=para.flagTitle;
  document.getElementById('bobFlagBody').style.background=para.color;
  document.getElementById('bobBottom').style.background=para.color;
  document.querySelectorAll('.bob-wb').forEach(w=>w.style.background=para.color);
  for(let i=0;i<BODY_PAIRS.length;i++){
    const d=document.getElementById('bbd'+i);
    if(d){d.classList.toggle('active',i===idx);d.classList.toggle('done',i<idx);}
  }

  const body=document.getElementById('bobBody');
  body.innerHTML='';

  /* ‚îÄ‚îÄ Topic kicker ‚îÄ‚îÄ */
  const topicLbl=document.createElement('div');
  topicLbl.style.cssText=`font-family:"DM Mono",monospace;font-size:10px;letter-spacing:2.5px;text-transform:uppercase;margin-bottom:12px;flex-shrink:0;color:${para.color};`;
  topicLbl.textContent=para.topic;
  body.appendChild(topicLbl);

  /* ‚îÄ‚îÄ Row 1: Listing marker (big) + opinion phrase (smaller, inline) ‚îÄ‚îÄ */
  const claimRow=document.createElement('div');
  claimRow.style.cssText='display:flex;align-items:baseline;gap:8px;flex-wrap:wrap;flex-shrink:0;margin-bottom:10px;';

  const starterEl=document.createElement('span');
  const sLen=para.starter.length;
  const sFontSize=sLen>16?'clamp(1.6rem,5.5vw,2.2rem)':sLen>10?'clamp(2rem,7vw,2.8rem)':'clamp(2.4rem,8vw,3.4rem)';
  starterEl.style.cssText=`font-family:"Barlow Condensed",sans-serif;font-size:${sFontSize};font-weight:900;line-height:.9;letter-spacing:.5px;color:var(--ink);`;
  starterEl.textContent=para.starter;
  claimRow.appendChild(starterEl);

  if(para.opinion){
    const opEl=document.createElement('span');
    opEl.style.cssText=`font-family:"Instrument Sans",sans-serif;font-size:13px;font-weight:500;font-style:italic;color:${para.color};line-height:1;`;
    opEl.textContent=para.opinion;
    claimRow.appendChild(opEl);
  }
  body.appendChild(claimRow);

  /* ‚îÄ‚îÄ Key expression pill ‚îÄ‚îÄ */
  if(para.keyExpr){
    const keyEl=document.createElement('div');
    keyEl.style.cssText=`font-family:"DM Mono",monospace;font-size:10px;font-weight:500;letter-spacing:.5px;color:#fff;background:${para.color};display:inline-block;padding:4px 10px;border-radius:4px;margin-bottom:12px;flex-shrink:0;`;
    keyEl.textContent=para.keyExpr;
    body.appendChild(keyEl);
  }

  /* ‚îÄ‚îÄ Body sentences with linking words highlighted ‚îÄ‚îÄ */
  let html=para.rest;
  (para.links||[]).forEach(lw=>{
    const escaped=lw.replace(/[.*+?^${}()|[\]\\]/g,'\\$&');
    html=html.replace(new RegExp(escaped),'<span style="color:var(--red);font-weight:700;font-family:\'DM Mono\',monospace;font-size:12px;letter-spacing:.3px;">'+lw+'</span>');
  });

  const paraEl=document.createElement('div');
  paraEl.style.cssText='font-family:"Instrument Sans",sans-serif;font-size:15px;font-weight:400;line-height:1.65;color:var(--ink);flex-shrink:0;opacity:0;transform:translateY(8px);transition:opacity .45s ease,transform .5s cubic-bezier(.22,1,.36,1);';
  paraEl.innerHTML=html;
  body.appendChild(paraEl);

  /* ‚îÄ‚îÄ Spacer ‚îÄ‚îÄ */
  const spacer=document.createElement('div');
  spacer.style.cssText='flex:1;min-height:6px;';
  body.appendChild(spacer);

  /* ‚îÄ‚îÄ Encouraging note ‚îÄ‚îÄ */
  if(para.note){
    const noteEl=document.createElement('div');
    noteEl.style.cssText='font-family:"DM Mono",monospace;font-size:9.5px;line-height:1.55;letter-spacing:.2px;color:rgba(28,28,30,.5);background:rgba(0,0,0,.04);border-left:2.5px solid rgba(0,0,0,.12);padding:7px 10px;border-radius:0 5px 5px 0;flex-shrink:0;opacity:0;transition:opacity .5s .6s ease;';
    noteEl.textContent='üí° ' + para.note;
    body.appendChild(noteEl);
    setTimeout(()=>{ noteEl.style.opacity='1'; }, 700);
  }

  /* Reveal text BEFORE speaking so it's readable while audio plays */
  await wait(60,myGen); /* one tick for DOM paint */
  if(!running||!bodyBannerOn||myGen!==gen){return;}
  paraEl.offsetHeight; /* force reflow so transition fires */
  paraEl.style.opacity='1';
  paraEl.style.transform='none';

  /* Small pause so fade-in is visible before speech starts */
  await wait(180,myGen);
  if(!running||!bodyBannerOn||myGen!==gen){return;}

  /* Speak whole paragraph while text is already showing */
  waveOn();
  const fullText = para.starter + (para.opinion ? " " + para.opinion + "," : "") + (para.keyExpr ? " " + para.keyExpr : "") + para.rest;
  await speak(fullText,myGen);
  if(!running||!bodyBannerOn||myGen!==gen){waveOff();return;}

  waveOff();
  await wait(600,myGen);
}

/* ‚îÄ‚îÄ‚îÄ CONCLUSION HELPER ‚îÄ‚îÄ‚îÄ */
async function speakThenShow(stkId,text,isFirst,role,kw,myGen){
  if(!running||myGen!==gen)return;
  await speak(text,myGen);
  if(!running||myGen!==gen)return;
  const stk=document.getElementById(stkId);if(!stk)return;
  const line=document.createElement('div');
  line.className='s-line'+(isFirst?' first':'');
  let html=text;
  if(kw)html=text.replace(kw,`<span style="color:var(--red);font-weight:700">${kw}</span>`);
  if(role)line.innerHTML=`<span class="s-role" style="color:var(--red);background:rgba(201,20,15,.07)">${role}</span>${html}`;
  else line.innerHTML=html;
  stk.appendChild(line);
  await wait(20,myGen);line.classList.add('in');
  line.scrollIntoView({behavior:'smooth',block:'nearest'});
  await wait(180,myGen);
}

/* ‚îÄ‚îÄ‚îÄ SCENE RUNNER ‚îÄ‚îÄ‚îÄ */
async function runScene(idx,myGen){
  if(!running||myGen!==gen)return;
  if(idx>=SCENE_COUNT){finishAll();return;}
  clearStacks();showScene(idx);

  if(idx===0){
    waveOn();
    await speak("Welcome to Essay Builder. By the end of this lesson, you will know exactly how to write a B2 opinion essay ‚Äî sentence by sentence, paragraph by paragraph.",myGen);
    if(!running||myGen!==gen){waveOff();return;}
    waveOff();

  }else if(idx===1){
    showInter('INTRODUCTION','var(--c-intro)','PARAGRAPH 1 OF 5','A <em>Hook.</em><br>A <em>Thesis.</em>','Two sentences only. Watch <strong>5 different ways</strong> to write them ‚Äî choose yours.','var(--c-intro)');
    await speak("The introduction is just two sentences. A hook, then a thesis. Now watch five different ways to write them.",myGen);
    if(!running||myGen!==gen)return;
    await wait(400,myGen);if(!running||myGen!==gen)return;
    hideInter();await wait(280,myGen);if(!running||myGen!==gen)return;
    waveOn();
    await speak("Here is today's essay question. Should the use of phones be limited for young people? What do you think? By the end of this lesson, you will know exactly how to argue it.",myGen);
    if(!running||myGen!==gen){waveOff();return;}
    waveOff();
    await wait(260,myGen);if(!running||myGen!==gen)return;
    await runPairs(myGen);

  }else if(idx===2){
    /* Rest slide ‚Äî natural intro to body section */
    waveOn();
    await speak("Now let's focus on the body paragraphs. This is where your argument is built.",myGen);
    if(!running||myGen!==gen){waveOff();return;}
    waveOff();

  }else if(idx===3){
    /* Pattern card ‚Äî then straight into examples */
    waveOn();
    await speak("Every paragraph has two things: a claim ‚Äî your point ‚Äî and support or development. Here is the pattern. Now let's see it in action.",myGen);
    if(!running||myGen!==gen){waveOff();return;}
    waveOff();
    await wait(500,myGen);if(!running||myGen!==gen)return;
    await runBodyPairs(myGen);

  }else if(idx===4){
    waveOn();
    await speak('Finally, the conclusion. Restate your opinion in different words. Never introduce new ideas. Use a summary opener, echo your two points, then give a final verdict.',myGen);
    if(!running||myGen!==gen){waveOff();return;}
    for(let i=0;i<CONCL_DATA.length;i++){
      if(!running||myGen!==gen){waveOff();return;}
      const row=CONCL_DATA[i];
      await speakThenShow('stk4',row.text,i===0,row.role,row.kw,myGen);
    }
    if(!running||myGen!==gen){waveOff();return;}
    waveOff();
  }

  if(!running||myGen!==gen)return;
  await wait(440,myGen);
  if(!running||myGen!==gen)return;

  /* Stop at section end ‚Äî do not chain into next section */
  const sectionEnd = SECTION_END[activeSection] ?? (SCENE_COUNT-1);
  if(idx >= sectionEnd){ finishSection(); return; }
  cur=idx+1;
  runScene(cur,myGen);
}

/* ‚îÄ‚îÄ‚îÄ PLAYBACK ‚îÄ‚îÄ‚îÄ */
function handlePlay(){
  if(!running){
    if(cur===0) activeSection='intro'; // overview defaults to intro section
    running=true;const myGen=gen;
    const b=document.getElementById('btnPlay');b.textContent='‚èπ';b.classList.add('running');
    updateNavBtns();runScene(cur,myGen);
  }else{hardStop();updateNavBtns();}
}
function clearStacks(){const el=document.getElementById('stk4');if(el)el.innerHTML='';}
function nextScene(){hardStop();clearStacks();if(cur+1<SCENE_COUNT)cur++;activeSection=sectionForScene(cur);showScene(cur);updateNavBtns();}
function prevScene(){if(cur===0)return;hardStop();clearStacks();cur=Math.max(0,cur-1);activeSection=sectionForScene(cur);showScene(cur);updateNavBtns();}
function updateNavBtns(){
  document.getElementById('btnPrev').disabled=cur<=0;
  document.getElementById('btnNext').disabled=cur>=SCENE_COUNT-1;
}
/* Resets play button after a section finishes naturally */
function finishSection(){
  hardStop();
  const b=document.getElementById('btnPlay');
  b.textContent='‚ñ∂';b.classList.remove('running');
  b.onclick=handlePlay;
  updateNavBtns();
}
function finishAll(){ finishSection(); }

/* ‚îÄ‚îÄ‚îÄ FX ‚îÄ‚îÄ‚îÄ */
function flashColor(){const f=document.getElementById('flash');f.classList.add('pop');setTimeout(()=>f.classList.remove('pop'),20);}
const EMJS=[['üìñ'],['üì±'],['üìê'],['üí™'],['‚úÖ']];
function spawnEmoji(idx){
  const list=EMJS[idx]||[];
  const r=document.getElementById('stage').getBoundingClientRect();
  list.forEach((em,i)=>{
    setTimeout(()=>{
      const el=document.createElement('div');el.className='fem';el.textContent=em;
      el.style.cssText=`left:${r.left+r.width*.2+Math.random()*r.width*.6}px;top:${r.top+r.height*.45+Math.random()*r.height*.35}px;animation-duration:${1.9+Math.random()*.7}s;`;
      document.body.appendChild(el);setTimeout(()=>el.remove(),2500);
    },i*160);
  });
}

document.addEventListener('keydown',e=>{
  if(e.key===' '){e.preventDefault();handlePlay();}
  if(e.key==='ArrowRight')nextScene();
  if(e.key==='ArrowLeft')prevScene();
  if(e.key==='Escape'){hardStop();updateNavBtns();closeNotes();}
});
let _tx=0;
document.addEventListener('touchstart',e=>_tx=e.changedTouches[0].screenX,{passive:true});
document.addEventListener('touchend',e=>{const dx=e.changedTouches[0].screenX-_tx;if(dx<-55)nextScene();if(dx>55)prevScene();});

window.addEventListener('resize',updateFooterVar);
loadVoice();buildDots();updateDots(0);showScene(0);updateNavBtns();
requestAnimationFrame(updateFooterVar);
</script>
</body>
</html>
